<!DOCTYPE html>
<html lang="ar" dir="rtl" id="main-html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAHER PLATFORM ULTIMATE PRO</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #bc202b;
            --bg: #0a0a0a;
            --surface: #161616;
            --text: #ffffff;
            --sub: #b1b1b1;
            --radius: 20px;
            --header-h: 75px;
            --transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* منع اختيار النصوص ومنع السحب لضمان احترافية التطبيق */
        * { 
            margin: 0; padding: 0; box-sizing: border-box; 
            font-family: 'Cairo', sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body { 
            background: var(--bg); color: var(--text); 
            overflow-x: hidden; width: 100vw; height: 100vh;
            touch-action: manipulation;
        }

        /* هيدر احترافي ثابت */
        header {
            height: var(--header-h); background: var(--surface);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 5%; position: sticky; top: 0; z-index: 2000;
            box-shadow: 0 4px 30px rgba(0,0,0,0.8);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .header-brand { display: flex; align-items: center; gap: 15px; }
        .site-title-area { font-weight: 900; font-size: 1.4rem; letter-spacing: -0.5px; }
        
        /* منطقة الفيديو المصغر في الهيدر كما طلبت */
        #header-video-wrapper {
            width: 110px; height: 50px; border-radius: 10px;
            overflow: hidden; border: 2px solid var(--primary);
            display: none; /* يظهر فقط عند تفعيله من الإدارة */
        }

        .header-tools { display: flex; align-items: center; gap: 20px; }
        .tool-icon { 
            cursor: pointer; font-size: 1.3rem; transition: var(--transition); 
            color: var(--text); position: relative;
        }
        .tool-icon:hover { color: var(--primary); transform: translateY(-2px); }

        /* نظام البحث المنبثق */
        .search-container { position: relative; display: flex; align-items: center; }
        .search-input-wrapper {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 0; overflow: hidden; transition: var(--transition);
            background: var(--surface); z-index: 100;
        }
        [dir="rtl"] .search-input-wrapper { right: 40px; }
        .search-container.active .search-input-wrapper { width: 220px; }
        .search-input-wrapper input {
            width: 100%; padding: 12px 18px; background: #1a1a1a;
            border: 1px solid var(--primary); color: #fff; border-radius: 30px;
            outline: none; box-shadow: 0 0 15px rgba(188, 32, 43, 0.2);
        }

        /* القائمة الجانبية المتقدمة */
        .sidebar-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px); display: none; z-index: 2500;
        }
        .sidebar {
            position: fixed; top: 0; bottom: 0; width: 310px;
            background: var(--surface); z-index: 3000; 
            transition: 0.5s cubic-bezier(0.8, 0, 0.2, 1);
            padding: 35px 25px; box-shadow: -10px 0 40px rgba(0,0,0,1);
            right: -100%; display: flex; flex-direction: column;
        }
        .sidebar.active { right: 0; }

        .nav-item {
            padding: 16px; border-radius: 15px; display: flex; align-items: center;
            gap: 15px; cursor: pointer; margin-bottom: 8px; font-weight: 700;
            transition: 0.3s; border: 1px solid transparent;
        }
        .nav-item:hover { background: rgba(188, 32, 43, 0.1); border-color: var(--primary); color: var(--primary); }
        .nav-item i { font-size: 1.4rem; width: 30px; }

        /* منطقة صورة العرض (Avatar) في القائمة الجانبية */
        .avatar-box {
            margin-top: auto; padding: 20px; border-radius: 20px;
            background: rgba(0,0,0,0.2); text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .avatar-img {
            width: 130px; height: 130px; border-radius: 25px;
            object-fit: cover; border: 3px solid var(--primary);
            margin-bottom: 15px; cursor: pointer; transition: 0.3s;
        }
        .avatar-img:active { transform: scale(0.9); }
        .avatar-desc-trigger { font-weight: 900; color: var(--primary); cursor: pointer; }

        /* الصفحات المتداخلة (Layered System) */
        .layer {
            position: fixed; inset: 0; background: var(--bg); z-index: 4000;
            display: none; flex-direction: column; animation: layerIn 0.5s ease;
        }
        @keyframes layerIn { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .layer-header {
            padding: 25px; background: var(--surface); display: flex;
            align-items: center; justify-content: space-between;
            border-bottom: 3px solid var(--primary);
        }
        .layer-body { flex: 1; padding: 25px; overflow-y: auto; }

        /* نموذج الإدارة (Admin Cards) */
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .admin-btn {
            background: var(--surface); padding: 30px 15px; border-radius: 20px;
            text-align: center; border: 1px solid #333; transition: 0.3s; cursor: pointer;
        }
        .admin-btn:hover { border-color: var(--primary); transform: translateY(-5px); }
        .admin-btn i { font-size: 2.5rem; color: var(--primary); margin-bottom: 15px; display: block; }

        /* تصميم مشغل الفيديو */
        .main-player-section { padding: 20px; }
        .video-wrapper {
            width: 100%; aspect-ratio: 16/9; background: #000;
            border-radius: var(--radius); overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.9);
        }
        
        /* شريط الأخبار العاجلة المطور */
        .news-flash {
            height: 50px; background: var(--primary); display: none;
            align-items: center; overflow: hidden; white-space: nowrap;
            font-weight: 900; position: relative; z-index: 1500;
        }
        .news-flash.bottom { margin-top: 10px; border-radius: 10px; }
        .marquee-text { display: inline-block; animation: marquee 15s linear infinite; padding-right: 50px; }
        @keyframes marquee { from { transform: translateX(100%); } to { transform: translateX(-100%); } }

        /* قائمة الاقتراحات */
        .suggestion-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px; padding: 20px;
        }
        .suggest-card {
            background: var(--surface); border-radius: 18px; overflow: hidden;
            display: flex; flex-direction: column; cursor: pointer; transition: 0.3s;
        }
        .suggest-card:hover { transform: scale(1.02); }
        .suggest-thumb { width: 100%; aspect-ratio: 16/9; object-fit: cover; }
        .suggest-info { padding: 15px; }
        .suggest-title { font-weight: 900; font-size: 1.1rem; line-height: 1.4; }

        /* المدخلات (Forms) */
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 10px; font-weight: 900; color: var(--primary); }
        input, textarea, select {
            width: 100%; padding: 18px; background: #111; border: 1px solid #333;
            color: #fff; border-radius: 15px; font-size: 1rem; outline: none;
        }
        input:focus { border-color: var(--primary); }
        .save-btn {
            background: var(--primary); color: #fff; padding: 20px;
            border: none; border-radius: 15px; width: 100%; font-weight: 900;
            font-size: 1.2rem; cursor: pointer; margin-top: 15px;
        }
    </style>
</head>
<body data-theme="dark">

    <div id="redirect-screen" class="layer" style="background:#000; justify-content:center; align-items:center; z-index:9999;">
        <h1 style="color:var(--primary); font-size:2rem;">MAHER PLATFORM</h1>
        <div id="redirect-timer" style="font-size:6rem; font-weight:900; margin:20px 0;">3</div>
        <p>جاري توجيهك الآن...</p>
    </div>

    <header>
        <div class="header-brand">
            <i class="fas fa-bars tool-icon" onclick="App.toggleSidebar()"></i>
            <div id="dynamic-header-content" class="header-brand">
                <div id="header-video-wrapper"></div>
                <span id="header-title-text" class="site-title-area">MAHER PLATFORM</span>
            </div>
        </div>
        <div class="header-tools">
            <div class="search-container" id="search-box">
                <i class="fas fa-search tool-icon" onclick="App.toggleSearch()"></i>
                <div class="search-input-wrapper">
                    <input type="text" id="main-search" placeholder="ابحث عن فيديوهات أو صور..." oninput="App.liveSearch()">
                </div>
            </div>
            <i class="fas fa-globe tool-icon" id="lang-btn" onclick="App.openLayer('lang-layer')"></i>
            <i class="fas fa-moon tool-icon" id="theme-btn" onclick="App.toggleTheme()"></i>
        </div>
    </header>

    <div id="flash-top" class="news-flash" onclick="App.handleFlashClick('top')">
        <div class="marquee-text" id="flash-top-text"></div>
    </div>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="App.toggleSidebar()"></div>
    <aside class="sidebar" id="sidebar">
        <h2 style="margin-bottom:30px; border-bottom:2px solid var(--primary); padding-bottom:10px;">الرئيسية</h2>
        <div class="nav-item" onclick="App.openLayer('gallery-layer')"><i class="fas fa-images"></i> <span>معرض الصور</span></div>
        <div class="nav-item" onclick="App.openLayer('admin-auth-layer')"><i class="fas fa-user-shield"></i> <span>إدارة المنصة</span></div>
        
        <div class="avatar-box">
            <img id="side-avatar-img" src="" class="avatar-img" onclick="App.showAvatarFullDesc()">
            <div class="avatar-desc-trigger" id="side-avatar-title" onclick="App.toggleAvatarDesc()">...</div>
            <div id="side-avatar-desc" style="display:none; font-size:0.85rem; margin-top:10px; color:var(--sub);"></div>
        </div>
    </aside>

    <main>
        <section class="main-player-section">
            <div class="video-wrapper" id="video-player-container">
                </div>
            
            <div id="flash-bottom" class="news-flash bottom" onclick="App.handleFlashClick('bottom')">
                <div class="marquee-text" id="flash-bottom-text"></div>
            </div>

            <div style="margin-top:25px; background:var(--surface); padding:20px; border-radius:20px;" id="video-info-area">
                <h1 id="active-item-title" style="font-weight:900; cursor:pointer;" onclick="App.toggleDescription()">...</h1>
                <div id="active-item-desc" style="display:none; margin-top:15px; padding-top:15px; border-top:1px solid #333; color:var(--sub); line-height:1.8;"></div>
            </div>
        </section>

        <h2 style="padding:0 20px; font-weight:900;">المحتوى المقترح</h2>
        <div class="suggestion-grid" id="main-grid">
            </div>
    </main>

    <script>
        // هنا سيبدأ الجزء الثاني من البرمجة المتسلسلة
    </script>
</body>
</html>
// ==========================================
// الجزء 2: محرك البيانات ونظام الأمان الذكي
// ==========================================

const App = {
    // قاعدة البيانات الضخمة للمنصة
    db: {
        config: {
            siteName: 'MAHER PLATFORM PRO',
            headerMode: 'text', // 'text' أو 'video'
            headerVideo: '',
            mainColor: '#bc202b',
            bgColor: '#0a0a0a',
            surfaceColor: '#161616',
            searchVisible: true,
            langVisible: true,
            themeVisible: true
        },
        // نظام الدخول الرباعي (4 خانات كما طلبت)
        auth: {
            user: 'maher',
            pass: '1234',
            code1: '0000',
            code2: '9999',
            isLocked: false
        },
        social: {
            facebook: '',
            tiktok: '',
            instagram: '',
            whatsapp: ''
        },
        avatar: {
            url: '',
            title: 'المدير العام',
            desc: 'مرحباً بكم في منصتي الاحترافية'
        },
        news: {
            top: { active: false, text: '', link: '', color: '#bc202b', expiry: null },
            bottom: { active: false, text: '', link: '', color: '#bc202b', expiry: null }
        },
        videos: [], // مخزن الفيديوهات
        images: []  // مخزن الصور (بأي مقاس)
    },

    // 1. تشغيل المنصة واستعادة البيانات
    init() {
        console.log("%c MAHER PLATFORM SYSTEM STARTING...", "color:red; font-size:20px; font-weight:bold;");
        const savedData = localStorage.getItem('MAHER_ULTIMATE_DATA');
        if (savedData) {
            try {
                this.db = JSON.parse(savedData);
            } catch (e) {
                console.error("خطأ في قراءة البيانات المحفوظة");
            }
        }
        this.applyAllSettings();
        this.renderMainContent();
    },

    // 2. تطبيق كافة الإعدادات (الألوان، العناوين، الأشكال)
    applyAllSettings() {
        const root = document.documentElement.style;
        const c = this.db.config;

        // تطبيق الألوان
        root.setProperty('--primary', c.mainColor);
        root.setProperty('--bg', c.bgColor);
        root.setProperty('--surface', c.surfaceColor);

        // تخصيص العنوان العلوي (نص أو فيديو)
        const headerTitle = document.getElementById('header-title-text');
        const headerVideo = document.getElementById('header-video-wrapper');
        
        if (c.headerMode === 'video' && c.headerVideo) {
            headerTitle.style.display = 'none';
            headerVideo.style.display = 'block';
            headerVideo.innerHTML = `<video src="${c.headerVideo}" autoplay loop muted playsinline style="width:100%; height:100%; object-fit:cover;"></video>`;
        } else {
            headerTitle.style.display = 'block';
            headerTitle.innerText = c.siteName;
            headerVideo.style.display = 'none';
        }

        // إخفاء/إظهار أدوات الهيدر
        document.getElementById('search-box').style.display = c.searchVisible ? 'flex' : 'none';
        document.getElementById('lang-btn').style.display = c.langVisible ? 'block' : 'none';
        document.getElementById('theme-btn').style.display = c.themeVisible ? 'block' : 'none';

        // تحديث صورة الأفاتار والوصف
        document.getElementById('side-avatar-img').src = this.db.avatar.url || 'https://via.placeholder.com/150';
        document.getElementById('side-avatar-title').innerText = this.db.avatar.title;
        document.getElementById('side-avatar-desc').innerText = this.db.avatar.desc;

        // تفعيل أشرطة الأخبار العاجلة
        this.updateNewsBars();
    },

    // 3. نظام الأمان الرباعي (التحقق من الدخول)
    async verifyAdminAccess(u, p, c1, c2) {
        // التحقق من الخانات الأربعة
        if (u === this.db.auth.user && 
            p === this.db.auth.pass && 
            c1 === this.db.auth.code1 && 
            c2 === this.db.auth.code2) {
            return true;
        }
        return false;
    },

    // 4. نظام التحويل الذكي (3 ثواني)
    socialRedirect(platform) {
        const url = this.db.social[platform];
        if (!url) {
            alert("لم يتم ضبط الرابط بعد!");
            return;
        }

        this.toggleSidebar(); // إغلاق القائمة
        const screen = document.getElementById('redirect-screen');
        const timerText = document.getElementById('redirect-timer');
        screen.style.display = 'flex';

        let timeLeft = 3;
        timerText.innerText = timeLeft;

        const interval = setInterval(() => {
            timeLeft--;
            timerText.innerText = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(interval);
                window.location.href = platform === 'whatsapp' ? `https://wa.me/${url.replace('+', '')}` : url;
            }
        }, 1000);
    },

    // 5. حفظ البيانات النهائي
    saveData() {
        localStorage.setItem('MAHER_ULTIMATE_DATA', JSON.stringify(this.db));
        this.applyAllSettings();
        console.log("تم حفظ التغييرات بنجاح!");
    }
};

// الجزء القادم سيحتوي على دوال فتح "الصفحات الرابعة" المتداخلة
                // ==========================================
// الجزء 3: نظام الطبقات (Layers) وإدارة الميديا
// ==========================================

Object.assign(App, {

    // 1. دالة فتح الطبقات (التي تغطي الشاشة بالكامل)
    openLayer(id) {
        const layer = document.getElementById(id);
        if (layer) {
            layer.style.display = 'flex';
        } else {
            // إذا لم تكن الطبقة موجودة، سنقوم بإنشائها برمجياً (نظام الطبقات الديناميكي)
            this.createDynamicLayer(id);
        }
    },

    closeLayer(id) {
        document.getElementById(id).style.display = 'none';
    },

    // 2. إنشاء طبقة الإدارة الرئيسية (لوحة التحكم)
    createDynamicLayer(id) {
        if (id === 'admin-auth-layer') {
            const html = `
                <div id="admin-auth-layer" class="layer">
                    <div class="layer-header">
                        <h2><i class="fas fa-lock"></i> مدخل المسؤول (نظام رباعي)</h2>
                        <i class="fas fa-times tool-icon" onclick="App.closeLayer('admin-auth-layer')"></i>
                    </div>
                    <div class="layer-body">
                        <div class="input-group">
                            <label>اسم المستخدم</label>
                            <input type="text" id="auth-u" placeholder="User">
                        </div>
                        <div class="input-group">
                            <label>كلمة المرور</label>
                            <input type="password" id="auth-p" placeholder="Pass">
                        </div>
                        <div class="admin-grid">
                            <div class="input-group">
                                <label>رمز التحقق 1</label>
                                <input type="password" id="auth-c1" placeholder="Code 1">
                            </div>
                            <div class="input-group">
                                <label>رمز التحقق 2</label>
                                <input type="password" id="auth-c2" placeholder="Code 2">
                            </div>
                        </div>
                        <button class="save-btn" onclick="App.handleAdminLogin()">دخول الإدارة</button>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
            document.getElementById('admin-auth-layer').style.display = 'flex';
        }

        if (id === 'admin-main-panel') {
            const html = `
                <div id="admin-main-panel" class="layer">
                    <div class="layer-header">
                        <h2><i class="fas fa-tools"></i> مركز التحكم الشامل</h2>
                        <i class="fas fa-times tool-icon" onclick="App.closeLayer('admin-main-panel')"></i>
                    </div>
                    <div class="layer-body">
                        <div class="admin-grid">
                            <div class="admin-btn" onclick="App.openLayer('add-video-layer')">
                                <i class="fas fa-plus-circle"></i>
                                <span>إضافة فيديو جديد</span>
                            </div>
                            <div class="admin-btn" onclick="App.openLayer('add-image-layer')">
                                <i class="fas fa-camera-retro"></i>
                                <span>إضافة صورة جديدة</span>
                            </div>
                            <div class="admin-btn" onclick="App.openLayer('manage-videos-layer')">
                                <i class="fas fa-video"></i>
                                <span>تعديل/حذف فيديوهات</span>
                            </div>
                            <div class="admin-btn" onclick="App.openLayer('manage-images-layer')">
                                <i class="fas fa-images"></i>
                                <span>تعديل/حذف صور</span>
                            </div>
                        </div>
                        <button class="save-btn" style="background:#333; margin-top:30px;" onclick="App.saveData(); location.reload();">حفظ الإعدادات النهائية وتطبيقها</button>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
            document.getElementById('admin-main-panel').style.display = 'flex';
        }

        // --- طبقة إضافة فيديو جديد (الصفحة الرابعة) ---
        if (id === 'add-video-layer') {
            const html = `
                <div id="add-video-layer" class="layer" style="z-index:5000;">
                    <div class="layer-header">
                        <h2>إضافة فيديو جديد</h2>
                        <i class="fas fa-arrow-left tool-icon" onclick="App.closeLayer('add-video-layer')"></i>
                    </div>
                    <div class="layer-body">
                        <div class="input-group"><label>رابط الفيديو (YouTube/Direct)</label><input type="text" id="v-url"></div>
                        <div class="input-group"><label>عنوان الفيديو</label><input type="text" id="v-title"></div>
                        <div class="input-group"><label>صندوق الوصف</label><textarea id="v-desc" rows="5"></textarea></div>
                        <button class="save-btn" onclick="App.addItem('video')">حفظ الفيديو الآن</button>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
            document.getElementById('add-video-layer').style.display = 'flex';
        }

        // --- طبقة إضافة صورة جديدة (بأي مقاس كما طلبت) ---
        if (id === 'add-image-layer') {
            const html = `
                <div id="add-image-layer" class="layer" style="z-index:5000;">
                    <div class="layer-header">
                        <h2>إضافة صورة/منشور جديد</h2>
                        <i class="fas fa-arrow-left tool-icon" onclick="App.closeLayer('add-image-layer')"></i>
                    </div>
                    <div class="layer-body">
                        <p style="color:var(--sub); margin-bottom:15px;">ملاحظة: الصور ستظهر بمقاسها الأصلي (طويل، مربع، عريض)</p>
                        <div class="input-group"><label>رابط الصورة</label><input type="text" id="img-url"></div>
                        <div class="input-group"><label>عنوان الصورة</label><input type="text" id="img-title"></div>
                        <div class="input-group"><label>الوصف أو النص المرافق</label><textarea id="img-desc" rows="5"></textarea></div>
                        <button class="save-btn" onclick="App.addItem('image')">حفظ الصورة الآن</button>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
            document.getElementById('add-image-layer').style.display = 'flex';
        }
    },

    // 3. دالة إضافة المحتوى (فيديو أو صور) للمخزن
    addItem(type) {
        if (type === 'video') {
            const newItem = {
                url: document.getElementById('v-url').value,
                title: document.getElementById('v-title').value,
                desc: document.getElementById('v-desc').value,
                id: Date.now()
            };
            if (!newItem.url || !newItem.title) return alert("أكمل البيانات!");
            this.db.videos.push(newItem);
            this.closeLayer('add-video-layer');
        } else {
            const newItem = {
                url: document.getElementById('img-url').value,
                title: document.getElementById('img-title').value,
                desc: document.getElementById('img-desc').value,
                id: Date.now()
            };
            if (!newItem.url || !newItem.title) return alert("أكمل البيانات!");
            this.db.images.push(newItem);
            this.closeLayer('add-image-layer');
        }
        this.saveData();
        alert("تم الحفظ بنجاح!");
    },

    // 4. معالجة تسجيل الدخول الرباعي
    handleAdminLogin() {
        const u = document.getElementById('auth-u').value;
        const p = document.getElementById('auth-p').value;
        const c1 = document.getElementById('auth-c1').value;
        const c2 = document.getElementById('auth-c2').value;

        if (u === this.db.auth.user && p === this.db.auth.pass && c1 === this.db.auth.code1 && c2 === this.db.auth.code2) {
            this.closeLayer('admin-auth-layer');
            this.openLayer('admin-main-panel');
        } else {
            alert("خطأ في بيانات الدخول الرباعية!");
        }
    }
});
                // ==========================================
// الجزء 4: تخصيص الألوان والخطوط وروابط التواصل
// ==========================================

Object.assign(App, {

    // 1. إنشاء طبقات التخصيص (تظهر عند الضغط في لوحة الإدارة)
    createCustomizationLayers() {
        // طبقة تغيير الألوان والخطوط
        const styleHtml = `
            <div id="theme-settings-layer" class="layer" style="z-index:6000;">
                <div class="layer-header">
                    <h2>تغيير الألوان والخطوط</h2>
                    <i class="fas fa-arrow-left tool-icon" onclick="App.closeLayer('theme-settings-layer')"></i>
                </div>
                <div class="layer-body">
                    <div class="input-group">
                        <label>اللون الأساسي (أزرار وحدود)</label>
                        <input type="color" id="set-primary-color" value="${this.db.config.mainColor}">
                    </div>
                    <div class="input-group">
                        <label>لون الخلفية الرئيسي</label>
                        <input type="color" id="set-bg-color" value="${this.db.config.bgColor}">
                    </div>
                    <div class="input-group">
                        <label>لون الأسطح (القوائم والبطاقات)</label>
                        <input type="color" id="set-surface-color" value="${this.db.config.surfaceColor}">
                    </div>
                    <button class="save-btn" onclick="App.saveThemeStyles()">حفظ تغييرات الألوان</button>
                </div>
            </div>`;

        // طبقة روابط التواصل الاجتماعي
        const socialHtml = `
            <div id="social-settings-layer" class="layer" style="z-index:6000;">
                <div class="layer-header">
                    <h2>روابط التواصل الاجتماعي</h2>
                    <i class="fas fa-arrow-left tool-icon" onclick="App.closeLayer('social-settings-layer')"></i>
                </div>
                <div class="layer-body">
                    <div class="input-group">
                        <label><i class="fab fa-facebook"></i> رابط فيسبوك</label>
                        <input type="text" id="set-fb" value="${this.db.social.facebook}" placeholder="https://facebook.com/...">
                    </div>
                    <div class="input-group">
                        <label><i class="fab fa-tiktok"></i> رابط تيك توك</label>
                        <input type="text" id="set-tk" value="${this.db.social.tiktok}" placeholder="https://tiktok.com/@...">
                    </div>
                    <div class="input-group">
                        <label><i class="fab fa-instagram"></i> رابط انستغرام</label>
                        <input type="text" id="set-ig" value="${this.db.social.instagram}" placeholder="https://instagram.com/...">
                    </div>
                    <div class="input-group">
                        <label><i class="fab fa-whatsapp"></i> رقم الواتساب (بالرمز الدولي)</label>
                        <input type="text" id="set-wa" value="${this.db.social.whatsapp}" placeholder="212600000000">
                    </div>
                    <button class="save-btn" onclick="App.saveSocialLinks()">حفظ روابط التواصل</button>
                </div>
            </div>`;

        document.body.insertAdjacentHTML('beforeend', styleHtml);
        document.body.insertAdjacentHTML('beforeend', socialHtml);
    },

    // 2. حفظ الألوان المخصصة
    saveThemeStyles() {
        this.db.config.mainColor = document.getElementById('set-primary-color').value;
        this.db.config.bgColor = document.getElementById('set-bg-color').value;
        this.db.config.surfaceColor = document.getElementById('set-surface-color').value;
        this.saveData();
        alert("تم تحديث الألوان! سيتم تطبيقها فوراً.");
        this.closeLayer('theme-settings-layer');
    },

    // 3. حفظ روابط التواصل
    saveSocialLinks() {
        this.db.social.facebook = document.getElementById('set-fb').value;
        this.db.social.tiktok = document.getElementById('set-tk').value;
        this.db.social.instagram = document.getElementById('set-ig').value;
        this.db.social.whatsapp = document.getElementById('set-wa').value;
        this.saveData();
        alert("تم حفظ الروابط بنجاح.");
        this.closeLayer('social-settings-layer');
    },

    // 4. تحديث قائمة الإدارة الرئيسية لتشمل الأزرار الجديدة
    updateAdminPanelUI() {
        // نعدل على الطبقة التي أنشأناها في الجزء الثالث لتشمل الخيارات الجديدة
        const adminBody = document.querySelector('#admin-main-panel .layer-body');
        if(adminBody) {
            const extraBtns = `
                <div class="admin-grid" style="margin-top:15px; border-top:1px solid #333; padding-top:15px;">
                    <div class="admin-btn" onclick="App.openCustomLayer('theme-settings-layer')">
                        <i class="fas fa-palette"></i>
                        <span>تغيير لون وخطوط الصفحة</span>
                    </div>
                    <div class="admin-btn" onclick="App.openCustomLayer('social-settings-layer')">
                        <i class="fas fa-share-alt"></i>
                        <span>روابط تواصل اجتماعي</span>
                    </div>
                </div>
            `;
            adminBody.insertAdjacentHTML('afterbegin', extraBtns);
        }
    },

    openCustomLayer(id) {
        if (!document.getElementById(id)) {
            this.createCustomizationLayers();
        }
        this.openLayer(id);
    }
});
                // ==========================================
// الجزء 5: نظام اللغات والتحكم في أيقونات الهيدر
// ==========================================

Object.assign(App, {

    // 1. قاموس اللغات المتكامل
    translations: {
        ar: { dir: 'rtl', search: 'بحث...', suggestions: 'المقترحات', langName: 'العربية' },
        en: { dir: 'ltr', search: 'Search...', suggestions: 'Suggestions', langName: 'English' },
        he: { dir: 'rtl', search: 'חיפוש...', suggestions: 'הצעות', langName: 'עברית' },
        fr: { dir: 'ltr', search: 'Recherche...', suggestions: 'Suggestions', langName: 'Français' },
        de: { dir: 'ltr', search: 'Suche...', suggestions: 'Vorschläge', langName: 'Deutsch' }
    },

    // 2. إنشاء طبقة إعدادات اللغات والواجهة (في لوحة الإدارة)
    createUILayers() {
        const uiHtml = `
            <div id="ui-settings-layer" class="layer" style="z-index:7000;">
                <div class="layer-header">
                    <h2>إعدادات اللغات والواجهة</h2>
                    <i class="fas fa-arrow-left tool-icon" onclick="App.closeLayer('ui-settings-layer')"></i>
                </div>
                <div class="layer-body">
                    <h3 style="color:var(--primary); margin-bottom:15px;">إظهار/إخفاء أدوات الهيدر</h3>
                    <div class="input-group" style="display:flex; justify-content:space-between; align-items:center; background:#222; padding:15px; border-radius:15px;">
                        <span>تفعيل زر البحث</span>
                        <input type="checkbox" id="check-search" ${this.db.config.searchVisible ? 'checked' : ''} style="width:30px; height:30px;">
                    </div>
                    <div class="input-group" style="display:flex; justify-content:space-between; align-items:center; background:#222; padding:15px; border-radius:15px;">
                        <span>تفعيل زر اللغات</span>
                        <input type="checkbox" id="check-lang" ${this.db.config.langVisible ? 'checked' : ''} style="width:30px; height:30px;">
                    </div>
                    <div class="input-group" style="display:flex; justify-content:space-between; align-items:center; background:#222; padding:15px; border-radius:15px;">
                        <span>تفعيل زر (ليل/نهار)</span>
                        <input type="checkbox" id="check-theme" ${this.db.config.themeVisible ? 'checked' : ''} style="width:30px; height:30px;">
                    </div>
                    
                    <h3 style="color:var(--primary); margin-top:20px; margin-bottom:15px;">اللغات المفعلة</h3>
                    <p style="font-size:0.8rem; color:var(--sub);">يمكن للمستخدمين الاختيار من اللغات التي تتركها مفعلة هنا.</p>
                    <div id="lang-toggles-container" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                        </div>

                    <button class="save-btn" onclick="App.saveUISettings()">حفظ إعدادات الواجهة</button>
                </div>
            </div>`;
        
        // طبقة اختيار اللغة للمستخدم العادي (تفتح من الهيدر)
        const userLangHtml = `
            <div id="lang-layer" class="layer" style="z-index:8000;">
                <div class="layer-header">
                    <h2>اختر اللغة / Select Language</h2>
                    <i class="fas fa-times tool-icon" onclick="App.closeLayer('lang-layer')"></i>
                </div>
                <div class="layer-body">
                    <div class="admin-grid" id="user-lang-grid">
                        </div>
                </div>
            </div>`;

        document.body.insertAdjacentHTML('beforeend', uiHtml);
        document.body.insertAdjacentHTML('beforeend', userLangHtml);
    },

    // 3. حفظ إعدادات الواجهة واللغات
    saveUISettings() {
        this.db.config.searchVisible = document.getElementById('check-search').checked;
        this.db.config.langVisible = document.getElementById('check-lang').checked;
        this.db.config.themeVisible = document.getElementById('check-theme').checked;
        
        this.saveData();
        alert("تم حفظ إعدادات الواجهة! سيتم إخفاء/إظهار الأدوات فوراً.");
        this.applyAllSettings();
        this.closeLayer('ui-settings-layer');
    },

    // 4. دالة تغيير لغة الموقع بالكامل
    changeLanguage(langCode) {
        const trans = this.translations[langCode];
        if (!trans) return;

        document.getElementById('main-html').dir = trans.dir;
        document.getElementById('main-html').lang = langCode;
        document.getElementById('main-search').placeholder = trans.search;
        // هنا يمكن إضافة ترجمات أكثر للعناصر الأخرى

        this.closeLayer('lang-layer');
        console.log("Language changed to: " + langCode);
    },

    // 5. إضافة زر "اللغات والواجهة" إلى لوحة الإدارة الرئيسية
    extendAdminPanelV2() {
        const adminBody = document.querySelector('#admin-main-panel .layer-body');
        const uiBtn = `
            <div class="admin-btn" onclick="App.openCustomUILayer()">
                <i class="fas fa-language"></i>
                <span>تغيير لغة الصفحة والتحكم بالأيقونات</span>
            </div>
        `;
        // نضع الزر في الجريد الموجود
        adminBody.querySelector('.admin-grid:last-of-type').insertAdjacentHTML('beforeend', uiBtn);
    },

    openCustomUILayer() {
        if (!document.getElementById('ui-settings-layer')) {
            this.createUILayers();
            // ملء خيارات اللغات
            const container = document.getElementById('user-lang-grid');
            Object.keys(this.translations).forEach(code => {
                container.innerHTML += `
                    <div class="admin-btn" onclick="App.changeLanguage('${code}')">
                        <i class="fas fa-globe"></i>
                        <span>${this.translations[code].langName}</span>
                    </div>
                `;
            });
        }
        this.openLayer('ui-settings-layer');
    }
});
                // ==========================================
// الجزء 6: نظام الخبر العاجل والتحكم في الأشرطة
// ==========================================

Object.assign(App, {

    // 1. إنشاء طبقة التحكم في الأخبار العاجلة (تفتح من الإدارة)
    createNewsControlLayer() {
        const newsHtml = `
            <div id="news-admin-layer" class="layer" style="z-index:9000;">
                <div class="layer-header">
                    <h2><i class="fas fa-bullhorn"></i> إدارة الخبر العاجل</h2>
                    <i class="fas fa-arrow-left tool-icon" onclick="App.closeLayer('news-admin-layer')"></i>
                </div>
                <div class="layer-body">
                    <div style="background:#222; padding:20px; border-radius:20px; margin-bottom:20px; border:1px solid var(--primary);">
                        <h3 style="color:var(--primary); margin-bottom:15px;">الشريط العلوي (فوق الموقع)</h3>
                        <div class="input-group">
                            <label>نص الخبر</label>
                            <input type="text" id="news-top-text" placeholder="اكتب الخبر هنا..." value="${this.db.news.top.text}">
                        </div>
                        <div class="input-group">
                            <label>رابط الخبر (اختياري)</label>
                            <input type="text" id="news-top-link" placeholder="https://..." value="${this.db.news.top.link}">
                        </div>
                        <div class="admin-grid">
                            <div class="input-group">
                                <label>لون الشريط</label>
                                <input type="color" id="news-top-color" value="${this.db.news.top.color}">
                            </div>
                            <div class="input-group">
                                <label>مدة الظهور (ساعة) - 0 للدائم</label>
                                <input type="number" id="news-top-time" value="0">
                            </div>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button class="save-btn" style="flex:2;" onclick="App.saveNews('top')">تفعيل الشريط العلوي</button>
                            <button class="save-btn" style="flex:1; background:#444;" onclick="App.toggleNewsStatus('top', false)">إيقاف</button>
                        </div>
                    </div>

                    <div style="background:#222; padding:20px; border-radius:20px; border:1px solid #444;">
                        <h3 style="color:var(--primary); margin-bottom:15px;">الشريط السفلي (تحت الفيديو)</h3>
                        <div class="input-group">
                            <label>نص الخبر</label>
                            <input type="text" id="news-bottom-text" placeholder="اكتب الخبر هنا..." value="${this.db.news.bottom.text}">
                        </div>
                        <div class="input-group">
                            <label>رابط الخبر</label>
                            <input type="text" id="news-bottom-link" value="${this.db.news.bottom.link}">
                        </div>
                        <div class="admin-grid">
                            <div class="input-group">
                                <label>لون الشريط</label>
                                <input type="color" id="news-bottom-color" value="${this.db.news.bottom.color}">
                            </div>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button class="save-btn" style="flex:2;" onclick="App.saveNews('bottom')">تفعيل الشريط السفلي</button>
                            <button class="save-btn" style="flex:1; background:#444;" onclick="App.toggleNewsStatus('bottom', false)">إيقاف</button>
                        </div>
                    </div>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', newsHtml);
    },

    // 2. حفظ بيانات الخبر وتحديث الواجهة
    saveNews(pos) {
        const text = document.getElementById(`news-${pos}-text`).value;
        const link = document.getElementById(`news-${pos}-link`).value;
        const color = document.getElementById(`news-${pos}-color`).value;
        const hours = pos === 'top' ? parseInt(document.getElementById('news-top-time').value) : 0;

        let expiry = null;
        if (hours > 0) {
            expiry = Date.now() + (hours * 60 * 60 * 1000);
        }

        this.db.news[pos] = { active: true, text, link, color, expiry };
        this.saveData();
        this.updateNewsBars();
        alert("تم تحديث شريط الخبر العاجل!");
    },

    // 3. تحديث مظهر الأشرطة في الصفحة الرئيسية
    updateNewsBars() {
        ['top', 'bottom'].forEach(pos => {
            const bar = document.getElementById(`flash-${pos}`);
            const data = this.db.news[pos];

            // تحقق من الصلاحية الزمنية
            if (data.active && data.expiry && Date.now() > data.expiry) {
                data.active = false;
            }

            if (data.active && data.text) {
                bar.style.display = 'flex';
                bar.style.background = data.color;
                bar.querySelector('.marquee-text').innerText = data.text;
                bar.style.cursor = data.link ? 'pointer' : 'default';
            } else {
                bar.style.display = 'none';
            }
        });
    },

    // 4. معالجة الضغط على الخبر (التحويل للرابط)
    handleFlashClick(pos) {
        const link = this.db.news[pos].link;
        if (link) {
            window.open(link, '_blank');
        }
    },

    toggleNewsStatus(pos, status) {
        this.db.news[pos].active = status;
        this.saveData();
        this.updateNewsBars();
        alert("تم تغيير حالة الشريط.");
    },

    // إضافة زر "الخبر العاجل" للوحة الإدارة
    extendAdminPanelV3() {
        const adminBody = document.querySelector('#admin-main-panel .layer-body');
        const newsBtn = `
            <div class="admin-btn" onclick="App.openNewsAdmin()">
                <i class="fas fa-bullhorn"></i>
                <span>إعدادات الخبر العاجل (عاجل)</span>
            </div>
        `;
        adminBody.querySelector('.admin-grid:last-of-type').insertAdjacentHTML('beforeend', newsBtn);
    },

    openNewsAdmin() {
        if (!document.getElementById('news-admin-layer')) {
            this.createNewsControlLayer();
        }
        this.openLayer('news-admin-layer');
    }
});
                // ==========================================
// الجزء 7: صورة العرض ونظام العنوان المتطور
// ==========================================

Object.assign(App, {

    // 1. إنشاء طبقة تغيير صورة العرض (Avatar) والوصف
    createAvatarLayer() {
        const avatarHtml = `
            <div id="avatar-settings-layer" class="layer" style="z-index:9500;">
                <div class="layer-header">
                    <h2><i class="fas fa-id-badge"></i> تغيير صورة العرض والوصف</h2>
                    <i class="fas fa-arrow-left tool-icon" onclick="App.closeLayer('avatar-settings-layer')"></i>
                </div>
                <div class="layer-body">
                    <div class="input-group">
                        <label>رابط صورة العرض (Avatar)</label>
                        <input type="text" id="set-avatar-url" value="${this.db.avatar.url}" placeholder="https://...">
                    </div>
                    <div class="input-group">
                        <label>العنوان الظاهر فوق الصورة</label>
                        <input type="text" id="set-avatar-title" value="${this.db.avatar.title}" placeholder="مثلاً: المدير العام">
                    </div>
                    <div class="input-group">
                        <label>وصف مطول (يدعم أسطر كثيرة)</label>
                        <textarea id="set-avatar-desc" rows="6" placeholder="اكتب هنا الوصف الذي سيظهر عند الضغط...">${this.db.avatar.desc}</textarea>
                    </div>
                    <button class="save-btn" onclick="App.saveAvatarData()">حفظ التغييرات</button>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', avatarHtml);
    },

    // 2. إنشاء طبقة تغيير عنوان الموقع أو تحويله لفيديو
    createTitleLayer() {
        const titleHtml = `
            <div id="title-settings-layer" class="layer" style="z-index:9500;">
                <div class="layer-header">
                    <h2><i class="fas fa-heading"></i> تخصيص عنوان الموقع</h2>
                    <i class="fas fa-arrow-left tool-icon" onclick="App.closeLayer('title-settings-layer')"></i>
                </div>
                <div class="layer-body">
                    <div class="input-group">
                        <label>اسم الموقع (نص)</label>
                        <input type="text" id="set-site-name" value="${this.db.config.siteName}">
                    </div>
                    <hr style="opacity:0.1; margin:20px 0;">
                    <h3 style="color:var(--primary); margin-bottom:15px;">خيار عرض فيديو بدل العنوان</h3>
                    <div class="input-group" style="display:flex; justify-content:space-between; align-items:center; background:#222; padding:15px; border-radius:15px;">
                        <span>تفعيل عرض الفيديو في الأعلى</span>
                        <input type="checkbox" id="check-header-video" ${this.db.config.headerMode === 'video' ? 'checked' : ''} style="width:25px; height:25px;">
                    </div>
                    <div class="input-group">
                        <label>رابط الفيديو الصغير (Direct Link)</label>
                        <input type="text" id="set-header-video-url" value="${this.db.config.headerVideo}" placeholder="رابط مباشر للفيديو...">
                    </div>
                    <button class="save-btn" onclick="App.saveTitleSettings()">حفظ وتطبيق المظهر</button>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', titleHtml);
    },

    // 3. حفظ بيانات الأفاتار
    saveAvatarData() {
        this.db.avatar.url = document.getElementById('set-avatar-url').value;
        this.db.avatar.title = document.getElementById('set-avatar-title').value;
        this.db.avatar.desc = document.getElementById('set-avatar-desc').value;
        this.saveData();
        alert("تم تحديث صورة العرض والبيانات!");
        this.closeLayer('avatar-settings-layer');
    },

    // 4. حفظ إعدادات العنوان والفيديو العلوي
    saveTitleSettings() {
        this.db.config.siteName = document.getElementById('set-site-name').value;
        this.db.config.headerMode = document.getElementById('check-header-video').checked ? 'video' : 'text';
        this.db.config.headerVideo = document.getElementById('set-header-video-url').value;
        this.saveData();
        alert("تم تحديث عنوان الموقع!");
        this.closeLayer('title-settings-layer');
    },

    // 5. وظائف التفاعل مع الأفاتار في القائمة الجانبية
    toggleAvatarDesc() {
        const descDiv = document.getElementById('side-avatar-desc');
        descDiv.style.display = descDiv.style.display === 'none' ? 'block' : 'none';
    },

    // إضافة الأزرار إلى لوحة الإدارة
    extendAdminPanelV4() {
        const adminBody = document.querySelector('#admin-main-panel .layer-body');
        const extraBtns = `
            <div class="admin-grid" style="margin-top:15px; border-top:1px solid #333; padding-top:15px;">
                <div class="admin-btn" onclick="App.openAvatarAdmin()">
                    <i class="fas fa-image"></i>
                    <span>تغيير صورة العرض</span>
                </div>
                <div class="admin-btn" onclick="App.openTitleAdmin()">
                    <i class="fas fa-font"></i>
                    <span>تغيير العنوان (نص/فيديو)</span>
                </div>
            </div>
        `;
        adminBody.querySelector('.layer-body').insertAdjacentHTML('beforeend', extraBtns);
    },

    openAvatarAdmin() {
        if (!document.getElementById('avatar-settings-layer')) this.createAvatarLayer();
        this.openLayer('avatar-settings-layer');
    },

    openTitleAdmin() {
        if (!document.getElementById('title-settings-layer')) this.createTitleLayer();
        this.openLayer('title-settings-layer');
    }
});
                // ==========================================
// الجزء 8: إدارة المحتوى (التعديل والحذف)
// ==========================================

Object.assign(App, {

    // 1. إنشاء طبقة إدارة الفيديوهات (قائمة التعديل والحذف)
    createManageVideosLayer() {
        const listHtml = `
            <div id="manage-videos-layer" class="layer" style="z-index:9600;">
                <div class="layer-header">
                    <h2><i class="fas fa-edit"></i> إدارة الفيديوهات المحفوظة</h2>
                    <i class="fas fa-arrow-left tool-icon" onclick="App.closeLayer('manage-videos-layer')"></i>
                </div>
                <div class="layer-body" id="videos-manage-list">
                    </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', listHtml);
    },

    // 2. إنشاء طبقة إدارة الصور
    createManageImagesLayer() {
        const listHtml = `
            <div id="manage-images-layer" class="layer" style="z-index:9600;">
                <div class="layer-header">
                    <h2><i class="fas fa-images"></i> إدارة معرض الصور</h2>
                    <i class="fas fa-arrow-left tool-icon" onclick="App.closeLayer('manage-images-layer')"></i>
                </div>
                <div class="layer-body" id="images-manage-list">
                    </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', listHtml);
    },

    // 3. عرض قائمة العناصر للإدارة
    renderManageList(type) {
        const container = document.getElementById(type === 'video' ? 'videos-manage-list' : 'images-manage-list');
        const items = type === 'video' ? this.db.videos : this.db.images;
        
        if (items.length === 0) {
            container.innerHTML = `<p style="text-align:center; color:gray; padding:50px;">لا يوجد محتوى لعرضه حالياً.</p>`;
            return;
        }

        container.innerHTML = items.map((item, index) => `
            <div style="background:#222; margin-bottom:15px; padding:15px; border-radius:15px; border-right:5px solid var(--primary);">
                <div style="font-weight:bold; margin-bottom:10px;">${item.title}</div>
                <div style="display:flex; gap:10px;">
                    <button class="save-btn" style="padding:10px; font-size:0.8rem;" onclick="App.openEditItemLayer('${type}', ${index})">تعديل</button>
                    <button class="save-btn" style="padding:10px; font-size:0.8rem; background:#444;" onclick="App.deleteItem('${type}', ${index})">حذف</button>
                </div>
            </div>
        `).join('');
    },

    // 4. شاشة التعديل (الصفحة الرابعة المتداخلة)
    openEditItemLayer(type, index) {
        const item = type === 'video' ? this.db.videos[index] : this.db.images[index];
        const editHtml = `
            <div id="edit-item-layer" class="layer" style="z-index:9900;">
                <div class="layer-header">
                    <h2>تعديل البيانات</h2>
                    <i class="fas fa-times tool-icon" onclick="App.closeLayer('edit-item-layer')"></i>
                </div>
                <div class="layer-body">
                    <div class="input-group"><label>الرابط</label><input type="text" id="edit-url" value="${item.url}"></div>
                    <div class="input-group"><label>العنوان</label><input type="text" id="edit-title" value="${item.title}"></div>
                    <div class="input-group"><label>الوصف</label><textarea id="edit-desc" rows="5">${item.desc}</textarea></div>
                    <button class="save-btn" onclick="App.saveEdit('${type}', ${index})">حفظ التعديلات والعودة</button>
                </div>
            </div>`;
        
        // إزالة أي طبقة تعديل سابقة لضمان عدم التكرار
        const oldLayer = document.getElementById('edit-item-layer');
        if (oldLayer) oldLayer.remove();

        document.body.insertAdjacentHTML('beforeend', editHtml);
        this.openLayer('edit-item-layer');
    },

    // 5. حفظ التعديل أو الحذف
    saveEdit(type, index) {
        const target = type === 'video' ? this.db.videos : this.db.images;
        target[index].url = document.getElementById('edit-url').value;
        target[index].title = document.getElementById('edit-title').value;
        target[index].desc = document.getElementById('edit-desc').value;
        
        this.saveData();
        this.closeLayer('edit-item-layer');
        this.renderManageList(type);
        alert("تم التعديل بنجاح!");
    },

    deleteItem(type, index) {
        if (confirm("هل أنت متأكد من حذف هذا العنصر نهائياً؟")) {
            if (type === 'video') this.db.videos.splice(index, 1);
            else this.db.images.splice(index, 1);
            
            this.saveData();
            this.renderManageList(type);
        }
    }
});

// تعديل دوال الفتح لضمان تحديث البيانات عند كل فتح
App.originalOpenLayer = App.openLayer;
App.openLayer = function(id) {
    if (id === 'manage-videos-layer') {
        if (!document.getElementById(id)) this.createManageVideosLayer();
        this.renderManageList('video');
    }
    if (id === 'manage-images-layer') {
        if (!document.getElementById(id)) this.createManageImagesLayer();
        this.renderManageList('image');
    }
    this.originalOpenLayer(id);
};
              // ==========================================
// الجزء 9: إدارة الأمان المتقدمة والحفظ النهائي
// ==========================================

Object.assign(App, {

    // 1. إنشاء طبقة تغيير بيانات الدخول (نظام الأمان الرباعي)
    createSecurityLayer() {
        const secHtml = `
            <div id="security-settings-layer" class="layer" style="z-index:9800;">
                <div class="layer-header">
                    <h2><i class="fas fa-user-lock"></i> تغيير بيانات الدخول الرباعية</h2>
                    <i class="fas fa-arrow-left tool-icon" onclick="App.closeLayer('security-settings-layer')"></i>
                </div>
                <div class="layer-body">
                    <p style="color:var(--primary); margin-bottom:20px; font-weight:bold;">تنبيه: لا تترك هذه الخانات فارغة لضمان حماية موقعك.</p>
                    
                    <div class="input-group">
                        <label>اسم المستخدم الجديد</label>
                        <input type="text" id="new-user" value="${this.db.auth.user}">
                    </div>
                    <div class="input-group">
                        <label>كلمة المرور الجديدة</label>
                        <input type="password" id="new-pass" value="${this.db.auth.pass}">
                    </div>
                    
                    <div class="admin-grid">
                        <div class="input-group">
                            <label>الرمز الإضافي الأول</label>
                            <input type="password" id="new-c1" value="${this.db.auth.code1}">
                        </div>
                        <div class="input-group">
                            <label>الرمز الإضافي الثاني</label>
                            <input type="password" id="new-c2" value="${this.db.auth.code2}">
                        </div>
                    </div>

                    <button class="save-btn" onclick="App.saveNewSecurity()">تحديث بيانات الأمان</button>
                    
                    <div style="margin-top:30px; padding:15px; background:rgba(188, 32, 43, 0.1); border-radius:15px; border:1px dashed var(--primary);">
                        <p style="font-size:0.8rem; line-height:1.6;">بمجرد الحفظ، ستحتاج لاستخدام هذه البيانات الأربعة في المرة القادمة التي تدخل فيها إلى الإدارة.</p>
                    </div>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', secHtml);
    },

    // 2. حفظ بيانات الأمان الجديدة
    saveNewSecurity() {
        const u = document.getElementById('new-user').value;
        const p = document.getElementById('new-pass').value;
        const c1 = document.getElementById('new-c1').value;
        const c2 = document.getElementById('new-c2').value;

        if (!u || !p || !c1 || !c2) {
            alert("يرجى ملء جميع الخانات الأربعة!");
            return;
        }

        this.db.auth.user = u;
        this.db.auth.pass = p;
        this.db.auth.code1 = c1;
        this.db.auth.code2 = c2;

        this.saveData();
        alert("تم تحديث نظام الأمان الرباعي بنجاح!");
        this.closeLayer('security-settings-layer');
    },

    // 3. نظام "حفظ الإعدادات النهائي" (الزر الكبير في أسفل الإدارة)
    applyGlobalFinalSave() {
        // نقوم بعملية حفظ شاملة وإعادة تحميل لضمان تطبيق كل شيء
        this.saveData();
        
        // إظهار تأثير حركي بسيط للحفظ
        const btn = document.querySelector('.final-save-trigger');
        if(btn) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري تطبيق الإعدادات...';
            btn.style.background = '#28a745';
        }

        setTimeout(() => {
            location.reload(); // إعادة تحميل الصفحة لتطبيق الألوان والخطوط الجديدة
        }, 1500);
    },

    // إضافة زر الأمان والحفظ النهائي للوحة الإدارة
    extendAdminPanelV5() {
        const adminBody = document.querySelector('#admin-main-panel .layer-body');
        
        const finalSection = `
            <div style="margin-top:20px; border-top:2px solid #333; padding-top:20px;">
                <div class="admin-btn" style="border-color:#555;" onclick="App.openSecurityAdmin()">
                    <i class="fas fa-key" style="color:#ffc107;"></i>
                    <span>إعدادات الدخول (كلمات المرور)</span>
                </div>
                
                <button class="save-btn final-save-trigger" 
                        style="margin-top:20px; background:#bc202b; box-shadow: 0 10px 20px rgba(188,32,43,0.3);" 
                        onclick="App.applyGlobalFinalSave()">
                    <i class="fas fa-save"></i> حفظ جميع الإعدادات وتطبيقها الآن
                </button>
            </div>
        `;
        adminBody.insertAdjacentHTML('beforeend', finalSection);
    },

    openSecurityAdmin() {
        if (!document.getElementById('security-settings-layer')) this.createSecurityLayer();
        this.openLayer('security-settings-layer');
    }
});  
                // ==========================================
// الجزء 10: الربط النهائي، محرك البحث، وعرض الميديا
// ==========================================

Object.assign(App, {

    // 1. تشغيل المحتوى الرئيسي (فيديو وصور) في الصفحة
    renderMainContent() {
        const grid = document.getElementById('main-grid');
        if (this.db.videos.length === 0) {
            grid.innerHTML = `<div style="grid-column: 1/-1; text-align:center; padding:50px; opacity:0.5;">لا توجد فيديوهات مضافة حالياً. ادخل للإدارة وأضف محتواك الأول!</div>`;
            return;
        }

        grid.innerHTML = this.db.videos.map((vid, index) => `
            <div class="suggest-card" onclick="App.loadVideo(${index})">
                <img src="${this.getYouTubeThumb(vid.url)}" class="suggest-thumb" onerror="this.src='https://via.placeholder.com/400x225/222/fff?text=VIDEO'">
                <div class="suggest-info">
                    <div class="suggest-title">${vid.title}</div>
                    <div style="font-size:0.8rem; color:var(--sub); margin-top:5px;"><i class="fas fa-play-circle"></i> عرض الآن</div>
                </div>
            </div>
        `).join('');

        // تحميل أول فيديو تلقائياً عند البداية
        if (this.db.videos.length > 0) this.loadVideo(0, false);
    },

    // 2. محرك تشغيل الفيديو (يدعم يوتيوب والروابط المباشرة)
    loadVideo(index, scroll = true) {
        const vid = this.db.videos[index];
        const container = document.getElementById('video-player-container');
        const title = document.getElementById('active-item-title');
        const desc = document.getElementById('active-item-desc');

        title.innerText = vid.title;
        desc.innerHTML = vid.desc.replace(/(?:\r\n|\r|\n)/g, '<br>') || 'لا يوجد وصف متاح.';

        if (vid.url.includes('youtube.com') || vid.url.includes('youtu.be')) {
            const id = vid.url.includes('v=') ? vid.url.split('v=')[1].split('&')[0] : vid.url.split('/').pop();
            container.innerHTML = `<iframe src="https://www.youtube.com/embed/${id}?autoplay=1" allowfullscreen style="width:100%; height:100%; border:none;"></iframe>`;
        } else {
            container.innerHTML = `<video controls autoplay style="width:100%; height:100%;"><source src="${vid.url}"></video>`;
        }

        if (scroll) window.scrollTo({ top: 0, behavior: 'smooth' });
    },

    // 3. نظام عرض الصور (معرض الصور الاحترافي)
    createGalleryLayer() {
        const galleryHtml = `
            <div id="gallery-layer" class="layer" style="z-index:9999;">
                <div class="layer-header">
                    <h2><i class="fas fa-images"></i> معرض الصور والمنشورات</h2>
                    <i class="fas fa-times tool-icon" onclick="App.closeLayer('gallery-layer')"></i>
                </div>
                <div class="layer-body">
                    <div id="gallery-flow" style="display:flex; flex-direction:column; gap:30px;">
                        </div>
                </div>
            </div>`;
        
        if (!document.getElementById('gallery-layer')) document.body.insertAdjacentHTML('beforeend', galleryHtml);

        const container = document.getElementById('gallery-flow');
        if (this.db.images.length === 0) {
            container.innerHTML = `<p style="text-align:center; padding:50px;">المعرض فارغ حالياً.</p>`;
            return;
        }

        container.innerHTML = this.db.images.map(img => `
            <div class="gallery-item-full" style="background:var(--surface); border-radius:20px; overflow:hidden;">
                <img src="${img.url}" style="width:100%; height:auto; display:block;" onerror="this.src='https://via.placeholder.com/800x400?text=IMAGE+NOT+FOUND'">
                <div style="padding:20px;">
                    <h3 style="color:var(--primary); margin-bottom:10px;">${img.title}</h3>
                    <p style="color:var(--sub); line-height:1.6;">${img.desc}</p>
                </div>
            </div>
        `).join('');
    },

    // 4. نظام البحث المباشر
    liveSearch() {
        const query = document.getElementById('main-search').value.toLowerCase();
        const filtered = this.db.videos.filter(v => v.title.toLowerCase().includes(query) || v.desc.toLowerCase().includes(query));
        
        const grid = document.getElementById('main-grid');
        grid.innerHTML = filtered.map((vid, index) => `
            <div class="suggest-card" onclick="App.loadVideo(${this.db.videos.indexOf(vid)})">
                <img src="${this.getYouTubeThumb(vid.url)}" class="suggest-thumb">
                <div class="suggest-info"><div class="suggest-title">${vid.title}</div></div>
            </div>
        `).join('');
    },

    // 5. الوظائف المساعدة (تغيير السيم، إغلاق القائمة، إلخ)
    toggleTheme() {
        const body = document.body;
        const icon = document.getElementById('theme-btn');
        if (body.getAttribute('data-theme') === 'dark') {
            body.setAttribute('data-theme', 'light');
            body.style.background = '#f0f2f5';
            icon.className = 'fas fa-sun tool-icon';
        } else {
            body.setAttribute('data-theme', 'dark');
            body.style.background = this.db.config.bgColor;
            icon.className = 'fas fa-moon tool-icon';
        }
    },

    toggleSidebar() {
        const side = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const isActive = side.classList.toggle('active');
        overlay.style.display = isActive ? 'block' : 'none';
    },

    toggleSearch() {
        document.getElementById('search-box').classList.toggle('active');
    },

    toggleDescription() {
        const d = document.getElementById('active-item-desc');
        d.style.display = d.style.display === 'none' ? 'block' : 'none';
    },

    getYouTubeThumb(url) {
        if (url.includes('youtube.com') || url.includes('youtu.be')) {
            const id = url.includes('v=') ? url.split('v=')[1].split('&')[0] : url.split('/').pop();
            return `https://img.youtube.com/vi/${id}/mqdefault.jpg`;
        }
        return '';
    },

    // تشغيل نظام الطبقات المتداخلة في الإدارة
    openLayer(id) {
        if (id === 'gallery-layer') this.createGalleryLayer();
        if (id === 'admin-auth-layer') this.createDynamicLayer('admin-auth-layer');
        if (id === 'admin-main-panel') {
            this.createDynamicLayer('admin-main-panel');
            this.updateAdminPanelUI();
            this.extendAdminPanelV2();
            this.extendAdminPanelV3();
            this.extendAdminPanelV4();
            this.extendAdminPanelV5();
        }
        document.getElementById(id).style.display = 'flex';
    }
});

// إغلاق أي نافذة عند الضغط على مفتاح الهروب
window.addEventListener('keydown', (e) => { if(e.key === "Escape") document.querySelectorAll('.layer').forEach(l => l.style.display='none'); });

// التشغيل الرسمي للمنصة
window.onload = () => App.init();
