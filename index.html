<!DOCTYPE html>
<html lang="ar" dir="rtl" id="main-html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAHER PLATFORM PRO - ULTIMATE</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- المتغيرات الأساسية (تدعم التخصيص من الإدارة) --- */
        :root {
            --primary: #bc202b;
            --bg: #0a0a0a;
            --surface: #161616;
            --text: #ffffff;
            --sub: #b1b1b1;
            --radius: 15px;
            --header-font-size: 1.5rem;
            --header-color: #ffffff;
            --header-font-family: 'Cairo';
        }

        [data-theme="light"] {
            --bg: #f4f7f6;
            --surface: #ffffff;
            --text: #1a1a1a;
            --sub: #555;
        }

        /* --- التنسيق العام (CSS) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { 
            background: var(--bg); 
            color: var(--text); 
            transition: 0.5s; 
            overflow-x: hidden; 
            user-select: none; /* تجربة تطبيق */
        }

        /* الهيدر الأصلي */
        header {
            height: 70px; background: var(--surface); display: flex; align-items: center;
            justify-content: space-between; padding: 0 5%; position: sticky; top: 0; z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .header-center { flex: 1; text-align: center; overflow: hidden; }
        #ui-header-custom { 
            font-size: var(--header-font-size); 
            color: var(--header-color); 
            font-weight: 900;
        }
        #ui-header-vid { display: none; margin: 0 auto; border-radius: 5px; overflow: hidden; max-height: 50px; width: auto; }

        .header-tools { display: flex; align-items: center; gap: 15px; }
        .tool-icon { cursor: pointer; font-size: 1.2rem; transition: 0.3s; color: var(--text); }
        .tool-icon:hover { color: var(--primary); }

        /* البحث المتطور */
        .search-container { position: relative; display: flex; align-items: center; }
        .search-input-wrapper { 
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 0; overflow: hidden; transition: 0.4s; background: var(--surface);
        }
        [dir="rtl"] .search-input-wrapper { right: 0; }
        [dir="ltr"] .search-input-wrapper { left: 0; }
        [dir="rtl"] .search-container.active .search-input-wrapper { width: 150px; right: 30px; }
        [dir="ltr"] .search-container.active .search-input-wrapper { width: 150px; left: 30px; }
        .search-input-wrapper input { width: 100%; padding: 6px 12px; background: #222; border: 1px solid #444; color: white; border-radius: 20px; outline: none; font-size: 0.8rem; }

        /* القائمة الجانبية (Sidebar) */
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1999; display: none; }
        .sidebar {
            position: fixed; top: 0; bottom: 0; width: 280px;
            background: var(--surface); z-index: 2000; transition: 0.4s cubic-bezier(0.7, 0, 0.3, 1);
            padding: 25px; box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        [dir="rtl"] .sidebar { right: -100%; }
        [dir="rtl"] .sidebar.active { right: 0; }
        [dir="ltr"] .sidebar { left: -100%; }
        [dir="ltr"] .sidebar.active { left: 0; }

        .nav-link { padding: 12px; border-radius: 10px; display: flex; align-items: center; gap: 12px; cursor: pointer; margin-bottom: 5px; font-weight: 700; transition: 0.2s; color: var(--text); text-decoration: none; }
        .nav-link:hover { background: rgba(255,255,255,0.05); color: var(--primary); }

        /* الخبر العاجل المتطور */
        #news-container {
            background: var(--primary); color: #fff; padding: 10px 0; overflow: hidden;
            white-space: nowrap; display: none; cursor: pointer; font-weight: bold;
            position: relative; z-index: 10;
        }
        .marquee { display: inline-block; padding-right: 100%; animation: marquee 20s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        /* المشغل الرئيسي */
        .main-container { max-width: 1100px; margin: 0 auto; padding: 0 15px 50px; }
        .theater-mode { padding: 15px 0; }
        .video-box { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: var(--radius); overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        iframe, video { width: 100%; height: 100%; object-fit: contain; border: none; }

        .video-info { margin-top: 15px; cursor: pointer; background: var(--surface); padding: 15px; border-radius: var(--radius); }
        .video-title { font-size: 1.1rem; font-weight: 900; }
        #desc-panel { margin-top: 12px; color: var(--sub); display: none; border-top: 1px solid #333; padding-top: 10px; font-size: 0.9rem; line-height: 1.6; }

        /* شبكة المقترحات */
        .suggestions { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; }
        .thumb-item { display: flex; gap: 12px; cursor: pointer; background: var(--surface); padding: 8px; border-radius: 12px; transition: 0.3s; }
        .thumb-item:hover { background: #222; }
        .thumb-img-wrapper { width: 140px; aspect-ratio: 16/9; border-radius: 8px; overflow: hidden; flex-shrink: 0; }
        .thumb-img { width: 100%; height: 100%; object-fit: cover; }
        .thumb-content { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .thumb-text { font-weight: 700; font-size: 0.9rem; margin-bottom: 4px; }

        /* لوحات الإدارة والصفحات (Modals) */
        .full-modal { position: fixed; inset: 0; background: var(--bg); z-index: 5000; display: none; flex-direction: column; overflow-y: auto; }
        .modal-header { height: 70px; background: var(--surface); display: flex; align-items: center; justify-content: space-between; padding: 0 5%; border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 10; }
        .modal-body { padding: 25px; max-width: 800px; margin: 0 auto; width: 100%; }

        /* عناصر الفورم */
        .admin-card { background: var(--surface); padding: 20px; border-radius: 20px; margin-bottom: 20px; border: 1px solid #333; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--primary); font-size: 0.9rem; }
        input, textarea, select { width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; color: #fff; border-radius: 10px; outline: none; }
        input:focus { border-color: var(--primary); }
        .btn-action { background: var(--primary); color: #fff; padding: 12px; border: none; border-radius: 10px; width: 100%; font-weight: 900; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        .btn-action:active { transform: scale(0.98); }
        .btn-delete { background: #600; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }

        /* طبقة الانتقال (Redirect) */
        #redir-layer { position: fixed; inset: 0; background: #000; z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }

        /* معرض الصور */
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .gallery-card { background: var(--surface); border-radius: 15px; overflow: hidden; }
        .gallery-card img { width: 100%; display: block; height: auto; object-fit: contain; }

        /* نظام الإدارة المتدرج */
        .admin-entry-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .entry-box { background: var(--surface); border: 2px solid #333; padding: 25px; border-radius: 20px; text-align: center; cursor: pointer; transition: 0.3s; }
        .entry-box:hover { border-color: var(--primary); transform: translateY(-5px); }
        .entry-box i { font-size: 2.5rem; color: var(--primary); margin-bottom: 15px; }

        /* شاشة الدخول المتقدمة */
        .auth-container { max-width: 400px; margin: 100px auto; padding: 30px; background: var(--surface); border-radius: 30px; border: 1px solid #333; }

        /* التحكم في الأفاتار الجانبي */
        .side-profile { padding: 20px; text-align: center; border-bottom: 1px solid #333; margin-bottom: 10px; }
        .side-avatar { width: 100px; height: 100px; border-radius: 20px; object-fit: cover; border: 2px solid var(--primary); cursor: pointer; }
        .side-avatar-desc { font-size: 0.8rem; color: var(--sub); margin-top: 10px; display: none; }
    </style>
</head>
<body data-theme="dark">

    <div id="sidebar-overlay" class="sidebar-overlay" onclick="App.toggleMenu()"></div>

    <div id="redir-layer">
        <h2 id="redir-text" style="color:var(--primary); font-size: 1.5rem;">جاري التحويل...</h2>
        <div style="font-size:80px; font-weight:900; color:white;" id="redir-timer">3</div>
    </div>

    <div id="modal-auth" class="full-modal">
        <div class="auth-container">
            <h2 style="text-align:center; margin-bottom:20px;">حماية المسؤول</h2>
            <div id="auth-inputs-container">
                </div>
            <button class="btn-action" onclick="App.checkAuth()">تأكيد الدخول</button>
            <p onclick="App.closeAllModals()" style="text-align:center; margin-top:20px; cursor:pointer; color:gray">إلغاء</p>
        </div>
    </div>

    <div id="modal-admin-main" class="full-modal">
        <div class="modal-header">
            <h2>إدارة المحتوى</h2>
            <i class="fas fa-times tool-icon" onclick="App.closeAllModals()"></i>
        </div>
        <div class="modal-body">
            <div class="admin-entry-grid">
                <div class="entry-box" onclick="App.openSubModal('video')">
                    <i class="fas fa-video"></i>
                    <h3>إضافة فيديو</h3>
                </div>
                <div class="entry-box" onclick="App.openSubModal('image')">
                    <i class="fas fa-image"></i>
                    <h3>إضافة صورة</h3>
                </div>
            </div>

            <div style="margin-top:20px">
                <div class="nav-link admin-card" onclick="App.openSubModal('colors')"><i class="fas fa-palette"></i> تغير لون وخطوط الصفحة</div>
                <div class="nav-link admin-card" onclick="App.openSubModal('social')"><i class="fas fa-share-nodes"></i> روابط التواصل الاجتماعي</div>
                <div class="nav-link admin-card" onclick="App.openSubModal('lang-settings')"><i class="fas fa-language"></i> إعدادات اللغة والأدوات</div>
                <div class="nav-link admin-card" onclick="App.openSubModal('news-settings')"><i class="fas fa-bullhorn"></i> شريط الخبر العاجل</div>
                <div class="nav-link admin-card" onclick="App.openSubModal('avatar-settings')"><i class="fas fa-user-circle"></i> تغيير صورة العرض (القائمة)</div>
                <div class="nav-link admin-card" onclick="App.openSubModal('header-settings')"><i class="fas fa-heading"></i> تخصيص عنوان الموقع</div>
                <div class="nav-link admin-card" onclick="App.openSubModal('security-settings')"><i class="fas fa-lock"></i> إعدادات الدخول</div>
            </div>
            
            <button class="btn-action" style="margin: 40px 0; background: #222;" onclick="App.saveAndReload()">حفظ الكل وتطبيق التغييرات</button>
        </div>
    </div>

    <div id="modal-sub-video" class="full-modal">
        <div class="modal-header">
            <h2 id="video-modal-title">إضافة فيديو جديد</h2>
            <i class="fas fa-chevron-left tool-icon" onclick="App.backToAdmin()"></i>
        </div>
        <div class="modal-body">
            <div class="admin-card">
                <div class="form-group"><label>رابط الفيديو (Direct / Youtube / Tiktok)</label><input type="text" id="inp-v-url"></div>
                <div class="form-group"><label>عنوان الفيديو</label><input type="text" id="inp-v-title"></div>
                <div class="form-group"><label>صندوق الوصف</label><textarea id="inp-v-desc" rows="4"></textarea></div>
                <button class="btn-action" onclick="App.addItem('video')">حفظ الفيديو</button>
            </div>
            <h3 style="margin-bottom:15px">الفيديوهات الحالية</h3>
            <div id="list-videos"></div>
        </div>
    </div>

    <div id="modal-sub-image" class="full-modal">
        <div class="modal-header">
            <h2>إضافة صورة جديدة</h2>
            <i class="fas fa-chevron-left tool-icon" onclick="App.backToAdmin()"></i>
        </div>
        <div class="modal-body">
            <div class="admin-card">
                <div class="form-group"><label>رابط الصورة المباشر</label><input type="text" id="inp-g-url"></div>
                <div class="form-group"><label>عنوان الصورة</label><input type="text" id="inp-g-title"></div>
                <div class="form-group"><label>الوصف</label><textarea id="inp-g-desc" rows="3"></textarea></div>
                <button class="btn-action" onclick="App.addItem('image')">حفظ الصورة</button>
            </div>
            <h3 style="margin-bottom:15px">الصور الحالية</h3>
            <div id="list-gallery"></div>
        </div>
    </div>

    <div id="modal-sub-colors" class="full-modal">
        <div class="modal-header">
            <h2>تخصيص المظهر</h2>
            <i class="fas fa-chevron-left tool-icon" onclick="App.backToAdmin()"></i>
        </div>
        <div class="modal-body">
            <div class="admin-card">
                <div class="form-group"><label>اللون الرئيسي (Primary)</label><input type="color" id="set-color-main"></div>
                <div class="form-group"><label>لون الخلفية (Dark Mode)</label><input type="color" id="set-color-bg"></div>
                <div class="form-group"><label>لون الأسطح (Surfaces)</label><input type="color" id="set-color-surf"></div>
                <div class="form-group"><label>نوع الخط</label>
                    <select id="set-font">
                        <option value="'Cairo', sans-serif">Cairo (عربي)</option>
                        <option value="'Oswald', sans-serif">Oswald (Modern)</option>
                        <option value="'Arial', sans-serif">Arial</option>
                    </select>
                </div>
                <button class="btn-action" onclick="App.applyStyles()">تطبيق المعاينة</button>
            </div>
        </div>
    </div>

    <div id="modal-sub-social" class="full-modal">
        <div class="modal-header">
            <h2>روابط التواصل</h2>
            <i class="fas fa-chevron-left tool-icon" onclick="App.backToAdmin()"></i>
        </div>
        <div class="modal-body">
            <div class="admin-card">
                <div class="form-group"><label><i class="fab fa-facebook"></i> Facebook Link</label><input type="text" id="set-soc-fb"></div>
                <div class="form-group"><label><i class="fab fa-tiktok"></i> TikTok Link</label><input type="text" id="set-soc-tk"></div>
                <div class="form-group"><label><i class="fab fa-instagram"></i> Instagram Link</label><input type="text" id="set-soc-ig"></div>
                <div class="form-group"><label><i class="fab fa-whatsapp"></i> WhatsApp Number/Link</label><input type="text" id="set-soc-wa"></div>
                <button class="btn-action" onclick="App.updateSocial()">تحديث الروابط</button>
            </div>
        </div>
    </div>

    <div id="modal-sub-news-settings" class="full-modal">
        <div class="modal-header">
            <h2>إعدادات الخبر العاجل</h2>
            <i class="fas fa-chevron-left tool-icon" onclick="App.backToAdmin()"></i>
        </div>
        <div class="modal-body">
            <div class="admin-card">
                <div class="form-group"><label>حالة الشريط</label>
                    <select id="set-news-active"><option value="yes">مفعّل</option><option value="no">معطّل</option></select>
                </div>
                <div class="form-group"><label>نص الخبر</label><textarea id="set-news-text"></textarea></div>
                <div class="form-group"><label>رابط الخبر (اختياري)</label><input type="text" id="set-news-link"></div>
                <div class="form-group"><label>مدة الظهور (بالساعة - 0 للظهور الدائم)</label><input type="number" id="set-news-hours" value="0"></div>
                <div class="form-group"><label>لون الشريط</label><input type="color" id="set-news-color"></div>
                <button class="btn-action" onclick="App.updateNews()">تحديث الخبر</button>
            </div>
        </div>
    </div>

    <div id="modal-sub-header-settings" class="full-modal">
        <div class="modal-header">
            <h2>تخصيص عنوان الموقع</h2>
            <i class="fas fa-chevron-left tool-icon" onclick="App.backToAdmin()"></i>
        </div>
        <div class="modal-body">
            <div class="admin-card">
                <div class="form-group"><label>العنوان النصي</label><input type="text" id="set-head-text"></div>
                <div class="form-group"><label>لون العنوان</label><input type="color" id="set-head-color"></div>
                <div class="form-group"><label>حجم الخط</label><input type="range" min="15" max="40" id="set-head-size"></div>
                <hr style="margin:15px 0; opacity:0.1">
                <div class="form-group"><label>عرض فيديو بدل العنوان؟</label>
                    <select id="set-head-mode" onchange="App.toggleHeaderMode()"><option value="text">نص فقط</option><option value="video">فيديو مصغر</option></select>
                </div>
                <div id="head-vid-input" class="form-group" style="display:none;"><label>رابط فيديو العنوان</label><input type="text" id="set-head-vid-url"></div>
                <button class="btn-action" onclick="App.updateHeader()">تطبيق</button>
            </div>
        </div>
    </div>

    <div id="modal-public-gallery" class="full-modal">
        <div class="modal-header">
            <h2>المعرض والمنشورات</h2>
            <i class="fas fa-times tool-icon" onclick="App.closeAllModals()"></i>
        </div>
        <div class="modal-body">
            <div id="public-gallery-grid" class="gallery-grid"></div>
        </div>
    </div>

    <header>
        <div style="display:flex; align-items:center; gap:12px">
            <i class="fas fa-bars tool-icon" onclick="App.toggleMenu()"></i>
            <div class="header-center">
                <span id="ui-header-custom">MAHER PLATFORM</span>
                <div id="ui-header-vid"></div>
            </div>
        </div>

        <div class="header-tools">
            <div class="search-container" id="search-container">
                <i class="fas fa-search tool-icon" onclick="App.toggleSearch()"></i>
                <div class="search-input-wrapper">
                    <input type="text" id="search-input" placeholder="بحث..." oninput="App.search(this.value)">
                </div>
            </div>
            <i class="fas fa-globe tool-icon" onclick="App.showLangPicker()"></i>
            <i class="fas fa-adjust tool-icon" onclick="App.toggleTheme()"></i>
        </div>
    </header>

    <div id="news-container" onclick="App.newsClick()">
        <div class="marquee" id="ui-news-text">...</div>
    </div>

    <nav class="sidebar" id="sidebar">
        <div class="side-profile">
            <img src="" id="ui-avatar" class="side-avatar" onclick="App.toggleAvatarDesc()">
            <div id="ui-avatar-desc" class="side-avatar-desc">...</div>
        </div>
        
        <div class="nav-link" onclick="App.openPublicGallery()"><i class="fas fa-images"></i> <span class="lang-txt" data-key="navGallery">معرض الصور</span></div>
        <hr style="opacity:0.1; margin:15px 0">
        
        <div id="social-links-ui">
            </div>

        <hr style="opacity:0.1; margin:15px 0">
        <div class="nav-link" style="color:var(--primary)" onclick="App.showAuth()"><i class="fas fa-user-shield"></i> <span class="lang-txt" data-key="navAdmin">لوحة الإدارة</span></div>
    </nav>

    <main class="main-container">
        <section class="theater-mode">
            <div class="video-box" id="main-player"></div>
            <div class="video-info" onclick="App.toggleDesc()">
                <h1 class="video-title" id="active-title">تحميل...</h1>
                <div id="desc-panel"></div>
            </div>
        </section>

        <h2 style="margin-top:20px; font-weight:900;" class="lang-txt" data-key="suggestions">المقترحات</h2>
        <div class="suggestions" id="video-grid"></div>
    </main>

    <script>
        /*
        * ---------------------------------------------------------
        * تطبيق ماهر - الكود التشغيلي الكامل (Logic)
        * ---------------------------------------------------------
        */

        const App = {
            db: {
                config: {
                    user: 'maher',
                    pass: ['1234'], // يدعم مصفوفة كلمات مرور كما طلبت
                    siteName: 'MAHER PLATFORM',
                    headerMode: 'text',
                    headerVid: '',
                    headerColor: '#ffffff',
                    headerSize: '24',
                    theme: 'dark',
                    primaryColor: '#bc202b',
                    bgColor: '#0a0a0a',
                    surfColor: '#161616',
                    font: "'Cairo', sans-serif",
                    lang: 'ar'
                },
                news: { active: true, text: 'مرحباً بكم في منصة ماهر الاحترافية', link: '#', color: '#bc202b', expiry: 0 },
                avatar: { url: 'https://via.placeholder.com/150', desc: 'مدير المنصة: ماهر' },
                social: { facebook: '#', tiktok: '#', instagram: '#', whatsapp: '' },
                videos: [],
                gallery: []
            },

            init() {
                const saved = localStorage.getItem('MAHER_PRO_DATA_V10');
                if(saved) this.db = JSON.parse(saved);
                
                this.applyAllStyles();
                this.renderUI();
                if(this.db.videos.length > 0) this.loadVideo(0);
                
                // منع الزووم في الهواتف
                document.addEventListener('touchmove', function(e) {
                    if (e.scale !== 1) { e.preventDefault(); }
                }, { passive: false });
            },

            // --- نظام العرض (UI) ---
            renderUI() {
                // العنوان العلوي
                const hText = document.getElementById('ui-header-custom');
                const hVid = document.getElementById('ui-header-vid');
                if(this.db.config.headerMode === 'video') {
                    hText.style.display = 'none';
                    hVid.style.display = 'block';
                    hVid.innerHTML = this.getEmbed(this.db.config.headerVid, true);
                } else {
                    hText.style.display = 'block';
                    hVid.style.display = 'none';
                    hText.innerText = this.db.config.siteName;
                    hText.style.color = this.db.config.headerColor;
                    hText.style.fontSize = this.db.config.headerSize + 'px';
                }

                // الخبر العاجل
                const nc = document.getElementById('news-container');
                if(this.db.news.active) {
                    nc.style.display = 'block';
                    nc.style.background = this.db.news.color;
                    document.getElementById('ui-news-text').innerText = this.db.news.text;
                } else nc.style.display = 'none';

                // الأفاتار
                document.getElementById('ui-avatar').src = this.db.avatar.url;
                document.getElementById('ui-avatar-desc').innerText = this.db.avatar.desc;

                // السوشيال
                const sContainer = document.getElementById('social-links-ui');
                sContainer.innerHTML = '';
                const platforms = [
                    {key:'facebook', icon:'fab fa-facebook', color:'#1877F2', label:'Facebook'},
                    {key:'tiktok', icon:'fab fa-tiktok', color:'#fff', label:'TikTok'},
                    {key:'instagram', icon:'fab fa-instagram', color:'#E1306C', label:'Instagram'},
                    {key:'whatsapp', icon:'fab fa-whatsapp', color:'#25D366', label:'WhatsApp'}
                ];
                platforms.forEach(p => {
                    if(this.db.social[p.key]) {
                        const link = document.createElement('div');
                        link.className = 'nav-link';
                        link.innerHTML = `<i class="${p.icon}" style="color:${p.color}"></i> ${p.label}`;
                        link.onclick = () => this.handleSocialRedirect(p.key);
                        sContainer.appendChild(link);
                    }
                });

                // شبكة الفيديوهات
                const grid = document.getElementById('video-grid');
                grid.innerHTML = this.db.videos.map((v, i) => `
                    <div class="thumb-item" onclick="App.loadVideo(${i})">
                        <div class="thumb-img-wrapper"><img src="${this.getThumb(v.u)}" class="thumb-img"></div>
                        <div class="thumb-content">
                            <div class="thumb-text">${v.t}</div>
                            <div style="font-size:0.7rem; color:var(--sub)">انقر للمشاهدة</div>
                        </div>
                    </div>
                `).join('');
            },

            // --- نظام الفيديو ---
            loadVideo(idx) {
                const v = this.db.videos[idx];
                if(!v) return;
                document.getElementById('active-title').innerText = v.t;
                document.getElementById('desc-panel').innerHTML = this.linkify(v.d);
                document.getElementById('main-player').innerHTML = this.getEmbed(v.u);
                window.scrollTo({top:0, behavior:'smooth'});
            },

            getEmbed(url, isSmall = false) {
                if(!url) return '';
                if(url.includes('youtube.com') || url.includes('youtu.be')) {
                    const id = url.includes('v=') ? url.split('v=')[1].split('&')[0] : url.split('/').pop();
                    return `<iframe src="https://www.youtube.com/embed/${id}?autoplay=${isSmall?0:1}" allowfullscreen></iframe>`;
                }
                return `<video src="${url}" controls ${isSmall?'':'autoplay'}></video>`;
            },

            getThumb(url) {
                if(url.includes('youtube.com') || url.includes('youtu.be')) {
                    const id = url.includes('v=') ? url.split('v=')[1].split('&')[0] : url.split('/').pop();
                    return `https://img.youtube.com/vi/${id}/mqdefault.jpg`;
                }
                return 'https://via.placeholder.com/300x160/222/bc202b?text=VIDEO';
            },

            linkify(text) {
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                return text.replace(urlRegex, (url) => `<a href="${url}" target="_blank" style="color:var(--primary); text-decoration:underline;">${url}</a>`);
            },

            // --- الإدارة (Admin Logic) ---
            showAuth() { 
                this.toggleMenu();
                const container = document.getElementById('auth-inputs-container');
                container.innerHTML = '';
                // توليد عدد الخانات حسب مصفوفة الباسوردات (كحد أقصى 4 كما طلبت)
                this.db.config.pass.forEach((_, i) => {
                    const inp = document.createElement('input');
                    inp.type = 'password';
                    inp.placeholder = `الرمز السري ${i+1}`;
                    inp.className = 'auth-pass-input';
                    inp.style.marginBottom = '10px';
                    container.appendChild(inp);
                });
                document.getElementById('modal-auth').style.display = 'flex';
            },

            checkAuth() {
                const inputs = document.querySelectorAll('.auth-pass-input');
                let allCorrect = true;
                inputs.forEach((inp, i) => {
                    if(inp.value !== this.db.config.pass[i]) allCorrect = false;
                });

                if(allCorrect) {
                    this.closeAllModals();
                    document.getElementById('modal-admin-main').style.display = 'flex';
                } else {
                    alert("كلمات المرور غير متطابقة!");
                }
            },

            openSubModal(type) {
                this.closeAllModals();
                const m = document.getElementById('modal-sub-' + type);
                if(m) {
                    m.style.display = 'flex';
                    this.syncAdminInputs(type);
                }
            },

            syncAdminInputs(type) {
                if(type === 'video') this.renderAdminList('videos');
                if(type === 'image') this.renderAdminList('gallery');
                if(type === 'social') {
                    document.getElementById('set-soc-fb').value = this.db.social.facebook;
                    document.getElementById('set-soc-tk').value = this.db.social.tiktok;
                    document.getElementById('set-soc-ig').value = this.db.social.instagram;
                    document.getElementById('set-soc-wa').value = this.db.social.whatsapp;
                }
                if(type === 'header-settings') {
                    document.getElementById('set-head-text').value = this.db.config.siteName;
                    document.getElementById('set-head-color').value = this.db.config.headerColor;
                    document.getElementById('set-head-size').value = this.db.config.headerSize;
                    document.getElementById('set-head-mode').value = this.db.config.headerMode;
                    document.getElementById('set-head-vid-url').value = this.db.config.headerVid;
                    this.toggleHeaderMode();
                }
            },

            addItem(type) {
                if(type === 'video') {
                    const u = document.getElementById('inp-v-url').value;
                    const t = document.getElementById('inp-v-title').value;
                    const d = document.getElementById('inp-v-desc').value;
                    if(!u || !t) return;
                    this.db.videos.push({u, t, d});
                    document.getElementById('inp-v-url').value = '';
                    document.getElementById('inp-v-title').value = '';
                } else {
                    const u = document.getElementById('inp-g-url').value;
                    const t = document.getElementById('inp-g-title').value;
                    const d = document.getElementById('inp-g-desc').value;
                    if(!u) return;
                    this.db.gallery.push({u, t, d});
                }
                this.renderAdminList(type === 'video' ? 'videos' : 'gallery');
            },

            renderAdminList(key) {
                const container = document.getElementById(key === 'videos' ? 'list-videos' : 'list-gallery');
                container.innerHTML = this.db[key].map((item, i) => `
                    <div class="admin-card" style="display:flex; justify-content:space-between; align-items:center;">
                        <div><strong>${item.t || 'بدون عنوان'}</strong></div>
                        <div>
                            <button class="btn-delete" onclick="App.removeItem('${key}', ${i})">حذف</button>
                        </div>
                    </div>
                `).join('');
            },

            removeItem(key, i) {
                this.db[key].splice(i, 1);
                this.renderAdminList(key);
            },

            // --- إعدادات المظهر المتقدمة ---
            applyStyles() {
                this.db.config.primaryColor = document.getElementById('set-color-main').value;
                this.db.config.bgColor = document.getElementById('set-color-bg').value;
                this.db.config.surfColor = document.getElementById('set-color-surf').value;
                this.db.config.font = document.getElementById('set-font').value;
                this.applyAllStyles();
            },

            applyAllStyles() {
                const r = document.documentElement.style;
                r.setProperty('--primary', this.db.config.primaryColor);
                r.setProperty('--bg', this.db.config.bgColor);
                r.setProperty('--surface', this.db.config.surfColor);
                document.body.style.fontFamily = this.db.config.font;
            },

            updateHeader() {
                this.db.config.siteName = document.getElementById('set-head-text').value;
                this.db.config.headerColor = document.getElementById('set-head-color').value;
                this.db.config.headerSize = document.getElementById('set-head-size').value;
                this.db.config.headerMode = document.getElementById('set-head-mode').value;
                this.db.config.headerVid = document.getElementById('set-head-vid-url').value;
                this.renderUI();
                alert("تم تحديث العنوان");
            },

            toggleHeaderMode() {
                const mode = document.getElementById('set-head-mode').value;
                document.getElementById('head-vid-input').style.display = (mode === 'video' ? 'block' : 'none');
            },

            // --- التحويل والسوشيال ---
            handleSocialRedirect(p) {
                const layer = document.getElementById('redir-layer');
                const timer = document.getElementById('redir-timer');
                let count = 3;
                
                layer.style.display = 'flex';
                timer.innerText = count;

                const interval = setInterval(() => {
                    count--;
                    timer.innerText = count;
                    if(count <= 0) {
                        clearInterval(interval);
                        let url = this.db.social[p];
                        if(p === 'whatsapp' && !url.startsWith('http')) url = 'https://wa.me/' + url;
                        window.location.href = url;
                    }
                }, 1000);
            },

            // --- وظائف المودال ---
            toggleMenu() {
                const s = document.getElementById('sidebar');
                const o = document.getElementById('sidebar-overlay');
                s.classList.toggle('active');
                o.style.display = s.classList.contains('active') ? 'block' : 'none';
            },
            closeAllModals() {
                document.querySelectorAll('.full-modal').forEach(m => m.style.display = 'none');
            },
            backToAdmin() {
                this.closeAllModals();
                document.getElementById('modal-admin-main').style.display = 'flex';
            },
            saveAndReload() {
                localStorage.setItem('MAHER_PRO_DATA_V10', JSON.stringify(this.db));
                location.reload();
            },
            toggleDesc() {
                const p = document.getElementById('desc-panel');
                p.style.display = (p.style.display === 'block' ? 'none' : 'block');
            },
            toggleAvatarDesc() {
                const d = document.getElementById('ui-avatar-desc');
                d.style.display = (d.style.display === 'block' ? 'none' : 'block');
            },
            openPublicGallery() {
                this.toggleMenu();
                const g = document.getElementById('public-gallery-grid');
                g.innerHTML = this.db.gallery.map(img => `
                    <div class="gallery-card">
                        <img src="${img.u}">
                        <div style="padding:15px">
                            <h3 style="color:var(--primary)">${img.t || ''}</h3>
                            <p style="font-size:0.8rem; color:var(--sub); margin-top:5px">${img.d || ''}</p>
                        </div>
                    </div>
                `).join('');
                document.getElementById('modal-public-gallery').style.display = 'flex';
            }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
