<!DOCTYPE html>
<html lang="ar" dir="rtl" id="main-html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAHER PLATFORM PRO - V10 ULTIMATE</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* =========================================
           1. المتغيرات الجذرية والتخصيص (Root)
           ========================================= */
        :root {
            --primary: #bc202b;
            --bg: #0a0a0a;
            --surface: #161616;
            --text: #ffffff;
            --sub: #b1b1b1;
            --radius: 15px;
            --header-h: 70px;
            --transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            --font-main: 'Cairo', sans-serif;
            --shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* الثيم الفاتح - يتم التحكم به من الإدارة */
        [data-theme="light"] {
            --bg: #f4f7f6;
            --surface: #ffffff;
            --text: #1a1a1a;
            --sub: #555;
        }

        /* =========================================
           2. التنسيق العام (Global Styles)
           ========================================= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-main);
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: var(--bg);
            color: var(--text);
            transition: background 0.5s, color 0.5s;
            overflow-x: hidden;
            line-height: 1.6;
            user-select: none; /* تجربة تطبيق احترافية */
        }

        /* منع التكبير */
        html, body {
            max-width: 100%;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        /* =========================================
           3. الهيدر (Header Customization)
           ========================================= */
        header {
            height: var(--header-h);
            background: var(--surface);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 5%;
            position: sticky;
            top: 0;
            z-index: 1100;
            box-shadow: 0 2px 15px rgba(0,0,0,0.6);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #ui-header-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header-title-text {
            font-weight: 900;
            font-size: 1.4rem;
            letter-spacing: 0.5px;
        }

        .header-video-mini {
            width: 120px;
            height: 40px;
            border-radius: 8px;
            overflow: hidden;
            display: none; /* تظهر فقط عند التفعيل من الإدارة */
        }

        .header-tools {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .tool-icon {
            cursor: pointer;
            font-size: 1.25rem;
            transition: var(--transition);
            color: var(--text);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .tool-icon:hover {
            background: rgba(255,255,255,0.1);
            color: var(--primary);
            transform: translateY(-2px);
        }

        /* =========================================
           4. البحث (Search Logic CSS)
           ========================================= */
        .search-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input-wrapper {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            overflow: hidden;
            transition: var(--transition);
            background: var(--surface);
            z-index: 5;
        }

        [dir="rtl"] .search-input-wrapper { right: 0; }
        [dir="ltr"] .search-input-wrapper { left: 0; }

        .search-container.active .search-input-wrapper {
            width: 220px;
            padding: 0 10px;
        }

        [dir="rtl"] .search-container.active .search-input-wrapper { right: 45px; }
        [dir="ltr"] .search-container.active .search-input-wrapper { left: 45px; }

        .search-input-wrapper input {
            width: 100%;
            padding: 10px 15px;
            background: #1a1a1a;
            border: 1px solid #333;
            color: white;
            border-radius: 25px;
            outline: none;
            font-size: 0.9rem;
        }

        /* =========================================
           5. القائمة الجانبية (Sidebar)
           ========================================= */
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1900;
            display: none;
            backdrop-filter: blur(4px);
        }

        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            width: 300px;
            background: var(--surface);
            z-index: 2000;
            transition: var(--transition);
            padding: 30px 20px;
            box-shadow: 0 0 40px rgba(0,0,0,1);
            display: flex;
            flex-direction: column;
        }

        [dir="rtl"] .sidebar { right: -320px; }
        [dir="ltr"] .sidebar { left: -320px; }

        .sidebar.active { transform: translateX(0); }
        [dir="rtl"] .sidebar.active { right: 0; }
        [dir="ltr"] .sidebar.active { left: 0; }

        .nav-link {
            padding: 14px 18px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            margin-bottom: 8px;
            font-weight: 700;
            transition: 0.3s;
            color: var(--text);
            text-decoration: none;
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.06);
            color: var(--primary);
            padding-right: 25px;
        }

        .sidebar-footer-img {
            margin-top: auto;
            text-align: center;
            border-top: 1px solid #333;
            padding-top: 20px;
        }

        .admin-banner-ui {
            width: 100%;
            max-height: 180px;
            object-fit: cover;
            border-radius: 15px;
            border: 2px solid var(--primary);
            cursor: pointer;
            transition: 0.3s;
        }

        .admin-banner-ui:hover {
            filter: brightness(1.2);
        }

        /* =========================================
           6. الخبر العاجل (Marquee System)
           ========================================= */
        #news-container {
            background: var(--primary);
            color: #fff;
            padding: 14px 0;
            overflow: hidden;
            white-space: nowrap;
            display: none;
            cursor: pointer;
            font-weight: 800;
            position: relative;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .marquee-content {
            display: inline-block;
            padding-right: 100%;
            animation: marquee-anim 25s linear infinite;
        }

        .marquee-content a {
            color: white;
            text-decoration: none;
            margin-left: 50px;
        }

        @keyframes marquee-anim {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        /* =========================================
           7. المشغل الرئيسي والمحتوى (Player & Grid)
           ========================================= */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 15px 100px;
        }

        .theater-mode {
            width: 100%;
            margin-bottom: 30px;
        }

        .video-box-container {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.05);
        }

        iframe, video {
            width: 100%;
            height: 100%;
            border: none;
            object-fit: contain;
        }

        .video-meta-data {
            margin-top: 20px;
            background: var(--surface);
            padding: 20px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: 0.3s;
        }

        .video-title-main {
            font-size: 1.4rem;
            font-weight: 900;
            color: var(--text);
        }

        .video-description-panel {
            margin-top: 15px;
            color: var(--sub);
            font-size: 0.95rem;
            display: none;
            border-top: 1px solid #333;
            padding-top: 15px;
            white-space: pre-line;
            word-wrap: break-word;
        }

        .video-description-panel a {
            color: var(--primary);
            text-decoration: underline;
        }

        /* قائمة المصغرات */
        .suggestions-section {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .thumb-card {
            background: var(--surface);
            border-radius: var(--radius);
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid transparent;
        }

        .thumb-card:hover {
            transform: translateY(-8px);
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .thumb-image-box {
            width: 100%;
            aspect-ratio: 16/9;
            position: relative;
            background: #111;
        }

        .thumb-image-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .thumb-info {
            padding: 15px;
        }

        .thumb-title {
            font-weight: 700;
            font-size: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* =========================================
           8. شاشات الإدارة (Admin Modals)
           ========================================= */
        .full-screen-modal {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 5000;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.4s;
        }

        .modal-header-admin {
            padding: 20px 5%;
            background: var(--surface);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid var(--primary);
        }

        .modal-body-admin {
            flex: 1;
            padding: 30px 5%;
            overflow-y: auto;
        }

        .admin-grid-menu {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .admin-menu-item {
            background: var(--surface);
            padding: 30px 20px;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            border: 1px solid #333;
        }

        .admin-menu-item:hover {
            border-color: var(--primary);
            background: #1e1e1e;
            transform: scale(1.03);
        }

        .admin-menu-item i {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .admin-form-group {
            background: var(--surface);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }

        .admin-label {
            display: block;
            margin-bottom: 12px;
            font-weight: 800;
            color: var(--primary);
        }

        .admin-input, .admin-textarea, .admin-select {
            width: 100%;
            padding: 15px;
            background: #0f0f0f;
            border: 1px solid #444;
            color: #fff;
            border-radius: 12px;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .admin-btn {
            background: var(--primary);
            color: #fff;
            padding: 16px 30px;
            border: none;
            border-radius: 12px;
            font-weight: 900;
            cursor: pointer;
            width: 100%;
            font-size: 1.1rem;
            transition: 0.3s;
        }

        .admin-btn:active { transform: scale(0.95); }

        /* التحكم في السكرول */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--surface); border-radius: 10px; border: 2px solid var(--bg); }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* طبقة التحويل (Redirect Layer) */
        .redirect-fullscreen {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 10000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
    </style>
</head>
<body data-theme="dark">

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="App.toggleMenu()"></div>

    <div id="redirect-screen" class="redirect-fullscreen">
        <h1 id="redirect-msg" style="color:var(--primary); font-size: 2rem; margin-bottom: 20px;">جاري الانتقال...</h1>
        <div id="redirect-timer" style="font-size: 5rem; font-weight: 900; color: #fff;">3</div>
    </div>

    <div id="auth-modal" class="full-screen-modal" style="justify-content: center; align-items: center; background: rgba(0,0,0,0.95);">
        <div style="width: 100%; max-width: 450px; padding: 40px; background: var(--surface); border-radius: 30px; border: 1px solid var(--primary);">
            <h2 style="text-align:center; margin-bottom:30px; font-weight: 900;">قفل الأمان للمسؤول</h2>
            <div id="auth-inputs-wrapper">
                </div>
            <button class="admin-btn" onclick="App.verifyAuth()">فتح لوحة التحكم</button>
            <p onclick="App.closeAllModals()" style="text-align:center; margin-top:20px; cursor:pointer; opacity:0.6;">إلغاء الأمر</p>
        </div>
    </div>

    <div id="admin-main-modal" class="full-screen-modal">
        <div class="modal-header-admin">
            <h2><i class="fas fa-user-shield"></i> لوحة التحكم الشاملة</h2>
            <button class="tool-icon" onclick="App.closeAllModals()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body-admin">
            <div class="admin-grid-menu">
                <div class="admin-menu-item" onclick="App.openSubAdmin('videos')">
                    <i class="fas fa-video"></i>
                    <h3>إدارة الفيديوهات</h3>
                </div>
                <div class="admin-menu-item" onclick="App.openSubAdmin('images')">
                    <i class="fas fa-images"></i>
                    <h3>إدارة الصور</h3>
                </div>
                <div class="admin-menu-item" onclick="App.openSubAdmin('appearance')">
                    <i class="fas fa-paint-brush"></i>
                    <h3>الألوان والخطوط</h3>
                </div>
                <div class="admin-menu-item" onclick="App.openSubAdmin('social')">
                    <i class="fas fa-share-alt"></i>
                    <h3>روابط التواصل</h3>
                </div>
                <div class="admin-menu-item" onclick="App.openSubAdmin('news')">
                    <i class="fas fa-bolt"></i>
                    <h3>الخبر العاجل</h3>
                </div>
                <div class="admin-menu-item" onclick="App.openSubAdmin('profile')">
                    <i class="fas fa-id-card"></i>
                    <h3>صورة العرض</h3>
                </div>
                <div class="admin-menu-item" onclick="App.openSubAdmin('header-settings')">
                    <i class="fas fa-heading"></i>
                    <h3>العنوان العلوي</h3>
                </div>
                <div class="admin-menu-item" onclick="App.openSubAdmin('security')">
                    <i class="fas fa-key"></i>
                    <h3>إعدادات الدخول</h3>
                </div>
            </div>
            
            <button class="admin-btn" style="background: #222;" onclick="App.saveAllAndReload()">حفظ جميع الإعدادات النهائية وتحديث الموقع</button>
        </div>
    </div>

    <div id="sub-admin-videos" class="full-screen-modal">
        <div class="modal-header-admin">
            <h2>إضافة / تعديل الفيديوهات</h2>
            <button class="tool-icon" onclick="App.backToMainAdmin()"><i class="fas fa-arrow-left"></i></button>
        </div>
        <div class="modal-body-admin">
            <div class="admin-form-group">
                <label class="admin-label">رابط الفيديو (YouTube/Direct)</label>
                <input type="text" id="v-input-url" class="admin-input" placeholder="https://...">
                <label class="admin-label">عنوان الفيديو</label>
                <input type="text" id="v-input-title" class="admin-input">
                <label class="admin-label">وصف الفيديو (يدعم الروابط)</label>
                <textarea id="v-input-desc" class="admin-textarea" rows="4"></textarea>
                <button class="admin-btn" onclick="App.addVideoItem()">حفظ الفيديو الجديد</button>
            </div>
            <div id="admin-video-list-items"></div>
        </div>
    </div>

    <div id="sub-admin-images" class="full-screen-modal">
        <div class="modal-header-admin">
            <h2>إدارة معرض الصور</h2>
            <button class="tool-icon" onclick="App.backToMainAdmin()"><i class="fas fa-arrow-left"></i></button>
        </div>
        <div class="modal-body-admin">
            <div class="admin-form-group">
                <label class="admin-label">رابط الصورة (أي مقاس)</label>
                <input type="text" id="img-input-url" class="admin-input">
                <label class="admin-label">عنوان الصورة</label>
                <input type="text" id="img-input-title" class="admin-input">
                <label class="admin-label">وصف قصير</label>
                <textarea id="img-input-desc" class="admin-textarea"></textarea>
                <button class="admin-btn" onclick="App.addImageItem()">إضافة للصورة</button>
            </div>
            <div id="admin-image-list-items" class="suggestions-section"></div>
        </div>
    </div>

    <div id="sub-admin-news" class="full-screen-modal">
        <div class="modal-header-admin">
            <h2>تحكم الشريط الإخباري</h2>
            <button class="tool-icon" onclick="App.backToMainAdmin()"><i class="fas fa-arrow-left"></i></button>
        </div>
        <div class="modal-body-admin">
            <div class="admin-form-group">
                <label class="admin-label">تفعيل الشريط العلوي؟</label>
                <select id="news-toggle" class="admin-select">
                    <option value="true">مفعّل</option>
                    <option value="false">معطل</option>
                </select>
                <label class="admin-label">نص الخبر</label>
                <textarea id="news-text-val" class="admin-textarea"></textarea>
                <label class="admin-label">رابط الخبر (اختياري)</label>
                <input type="text" id="news-link-val" class="admin-input">
                <label class="admin-label">لون خلفية الشريط</label>
                <input type="color" id="news-bg-val" class="admin-input">
                <label class="admin-label">مؤقت الظهور (بالساعة - 0 للظهور الدائم)</label>
                <input type="number" id="news-timer-val" class="admin-input" value="0">
                <button class="admin-btn" onclick="App.updateNewsConfig()">تطبيق الخبر العاجل</button>
            </div>
        </div>
    </div>

    <div id="sub-admin-header-settings" class="full-screen-modal">
        <div class="modal-header-admin">
            <h2>تخصيص الهوية العلوية</h2>
            <button class="tool-icon" onclick="App.backToMainAdmin()"><i class="fas fa-arrow-left"></i></button>
        </div>
        <div class="modal-body-admin">
            <div class="admin-form-group">
                <label class="admin-label">عنوان الموقع</label>
                <input type="text" id="header-text-val" class="admin-input">
                <label class="admin-label">حجم الخط (بكسل)</label>
                <input type="number" id="header-size-val" class="admin-input">
                <label class="admin-label">لون العنوان</label>
                <input type="color" id="header-color-val" class="admin-input">
                <hr style="margin: 20px 0; opacity: 0.1;">
                <label class="admin-label">عرض فيديو بدلاً من العنوان؟</label>
                <select id="header-mode-val" class="admin-select">
                    <option value="text">نص فقط</option>
                    <option value="video">فيديو مصغر</option>
                </select>
                <label class="admin-label">رابط الفيديو العلوي (إذا اخترت فيديو)</label>
                <input type="text" id="header-vid-url" class="admin-input">
                <button class="admin-btn" onclick="App.updateHeaderConfig()">حفظ إعدادات الهيدر</button>
            </div>
        </div>
    </div>

    <header>
        <div class="header-brand">
            <i class="fas fa-bars tool-icon" onclick="App.toggleMenu()"></i>
            <div id="ui-header-container">
                <span id="ui-site-name" class="header-title-text">...</span>
                <div id="ui-header-video" class="header-video-mini"></div>
            </div>
        </div>

        <div class="header-tools">
            <div class="search-container" id="search-tool-ui">
                <i class="fas fa-search tool-icon" onclick="App.toggleSearch()"></i>
                <div class="search-input-wrapper">
                    <input type="text" id="search-input" placeholder="بحث عن فيديو..." oninput="App.executeSearch(this.value)">
                </div>
            </div>
            <i class="fas fa-globe tool-icon" id="lang-tool-ui" onclick="App.showLanguageMenu()"></i>
            <i class="fas fa-moon tool-icon" id="theme-tool-ui" onclick="App.toggleTheme()"></i>
        </div>
    </header>

    <div id="news-container">
        <div class="marquee-content" id="ui-news-wrapper"></div>
    </div>

    <nav class="sidebar" id="sidebar">
        <h2 style="margin-bottom:25px; border-bottom:1px solid #333; padding-bottom:15px;">القائمة الرئيسية</h2>
        
        <div class="nav-link" onclick="App.openGalleryModal()">
            <i class="fas fa-images"></i> <span>معرض الصور</span>
        </div>
        
        <hr style="opacity:0.1; margin:15px 0">
        
        <div id="ui-social-sidebar-list">
            </div>

        <hr style="opacity:0.1; margin:15px 0">

        <div class="nav-link" onclick="App.showAuthModal()" style="color:var(--primary)">
            <i class="fas fa-user-shield"></i> <span>لوحة الإدارة</span>
        </div>

        <div class="sidebar-footer-img">
            <div id="ui-avatar-title" style="margin-bottom:10px; font-weight: 800; display:none;"></div>
            <img src="" id="ui-sidebar-avatar" class="admin-banner-ui" onclick="App.toggleAvatarMessage()">
            <div id="ui-avatar-desc" style="font-size:0.8rem; color:var(--sub); margin-top:10px; display:none;"></div>
        </div>
    </nav>

    <main class="main-container">
        
        <section class="theater-mode">
            <div class="video-box-container" id="main-player-frame">
                </div>
            
            <div class="video-meta-data" onclick="App.toggleDescription()">
                <h1 id="ui-active-video-title" class="video-title-main">جاري التحميل...</h1>
                <div id="ui-video-description" class="video-description-panel"></div>
            </div>
        </section>

        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
            <div style="width: 5px; height: 30px; background: var(--primary); border-radius: 10px;"></div>
            <h2 style="font-weight: 900;">الفيديوهات المقترحة</h2>
        </div>

        <div class="suggestions-section" id="ui-video-grid">
            </div>

    </main>

    <div id="public-gallery-modal" class="full-screen-modal">
        <div class="modal-header-admin">
            <h2>معرض الصور والمنشورات</h2>
            <button class="tool-icon" onclick="App.closeAllModals()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body-admin">
            <div id="ui-public-gallery-grid" class="suggestions-section"></div>
        </div>
    </div>
    <script>
/**
 * ============================================================
 * MAHER PLATFORM ENGINE - V10.0
 * كود برمجي موسع لإدارة المحتوى بالكامل
 * ============================================================
 */

const App = {
    // قاعدة البيانات الافتراضية
    db: {
        config: {
            siteName: 'MAHER PLATFORM',
            headerMode: 'text', // 'text' or 'video'
            headerVidUrl: '',
            headerFontSize: 24,
            headerColor: '#ffffff',
            primaryColor: '#bc202b',
            bgColor: '#0a0a0a',
            surfaceColor: '#161616',
            fontFamily: "'Cairo', sans-serif",
            theme: 'dark',
            showSearch: true,
            showLang: true,
            showTheme: true,
            authCodes: ['1234'], // يدعم مصفوفة من الأكواد كما طلبت
        },
        news: {
            enabled: true,
            text: 'مرحباً بكم في منصة ماهر الاحترافية.. تابعوا أحدث الحصريات هنا',
            link: '',
            bgColor: '#bc202b',
            timer: 0, // بالساعات
            startTime: Date.now()
        },
        profile: {
            avatarUrl: 'https://via.placeholder.com/300x200',
            title: 'المدير العام',
            description: 'مرحباً بك في لوحة التحكم الخاصة بي، يمكنك التواصل معي عبر الروابط الرسمية.'
        },
        social: {
            facebook: 'https://facebook.com',
            tiktok: 'https://tiktok.com',
            instagram: 'https://instagram.com',
            whatsapp: '212600000000'
        },
        videos: [],
        images: []
    },

    // تهيئة التطبيق
    init() {
        console.log("App Initializing...");
        
        // جلب البيانات المحفوظة
        const localData = localStorage.getItem('MAHER_CMS_DATA');
        if (localData) {
            this.db = JSON.parse(localData);
        }

        this.applyConfigurations();
        this.renderInterface();
        this.loadDefaultVideo();
        
        // إعداد المستمعات العامة
        this.setupEventListeners();
    },

    // تطبيق الإعدادات المرئية (CSS Styles)
    applyConfigurations() {
        const root = document.documentElement.style;
        const config = this.db.config;

        root.setProperty('--primary', config.primaryColor);
        root.setProperty('--bg', config.bgColor);
        root.setProperty('--surface', config.surfaceColor);
        root.setProperty('--font-main', config.fontFamily);

        document.body.setAttribute('data-theme', config.theme);
        
        // إظهار/إخفاء الأدوات العلوية
        document.getElementById('search-tool-ui').style.display = config.showSearch ? 'flex' : 'none';
        document.getElementById('lang-tool-ui').style.display = config.showLang ? 'flex' : 'none';
        document.getElementById('theme-tool-ui').style.display = config.showTheme ? 'flex' : 'none';
    },

    // بناء واجهة المستخدم
    renderInterface() {
        const config = this.db.config;
        const news = this.db.news;
        const profile = this.db.profile;

        // 1. الهيدر
        const titleUi = document.getElementById('ui-site-name');
        const videoUi = document.getElementById('ui-header-video');
        
        if (config.headerMode === 'video') {
            titleUi.style.display = 'none';
            videoUi.style.display = 'block';
            videoUi.innerHTML = `<iframe src="${this.formatEmbedUrl(config.headerVidUrl)}" muted autoplay loop></iframe>`;
        } else {
            titleUi.style.display = 'block';
            videoUi.style.display = 'none';
            titleUi.innerText = config.siteName;
            titleUi.style.fontSize = config.headerFontSize + 'px';
            titleUi.style.color = config.headerColor;
        }

        // 2. الخبر العاجل
        const newsContainer = document.getElementById('news-container');
        if (news.enabled) {
            newsContainer.style.display = 'block';
            newsContainer.style.background = news.bgColor;
            const linkTag = news.link ? `<a href="${news.link}" target="_blank">${news.text}</a>` : `<span>${news.text}</span>`;
            document.getElementById('ui-news-wrapper').innerHTML = linkTag + linkTag + linkTag; // تكرار للتأثير
        } else {
            newsContainer.style.display = 'none';
        }

        // 3. القائمة الجانبية والأفاتار
        document.getElementById('ui-sidebar-avatar').src = profile.avatarUrl;
        document.getElementById('ui-avatar-title').innerText = profile.title;
        document.getElementById('ui-avatar-desc').innerText = profile.description;

        // 4. السوشيال ميديا
        this.renderSocialLinks();

        // 5. شبكة الفيديوهات
        this.renderVideoGrid(this.db.videos);
    },

    // رندر السوشيال ميديا بتأثير التحويل
    renderSocialLinks() {
        const social = this.db.social;
        const container = document.getElementById('ui-social-sidebar-list');
        container.innerHTML = '';

        const platforms = [
            { id: 'facebook', icon: 'fab fa-facebook', color: '#1877F2', label: 'Facebook' },
            { id: 'tiktok', icon: 'fab fa-tiktok', color: '#fff', label: 'TikTok' },
            { id: 'instagram', icon: 'fab fa-instagram', color: '#E1306C', label: 'Instagram' },
            { id: 'whatsapp', icon: 'fab fa-whatsapp', color: '#25D366', label: 'WhatsApp' }
        ];

        platforms.forEach(p => {
            if (social[p.id]) {
                const div = document.createElement('div');
                div.className = 'nav-link';
                div.innerHTML = `<i class="${p.icon}" style="color:${p.color}"></i> <span>${p.label}</span>`;
                div.onclick = () => this.handleSocialRedirect(social[p.id], p.id);
                container.appendChild(div);
            }
        });
    },

    // معالجة التحويل 3 ثواني
    handleSocialRedirect(url, type) {
        this.toggleMenu();
        const screen = document.getElementById('redirect-screen');
        const timer = document.getElementById('redirect-timer');
        let count = 3;

        let finalUrl = url;
        if (type === 'whatsapp' && !url.startsWith('http')) {
            finalUrl = `https://wa.me/${url}`;
        }

        screen.style.display = 'flex';
        timer.innerText = count;

        const interval = setInterval(() => {
            count--;
            timer.innerText = count;
            if (count <= 0) {
                clearInterval(interval);
                window.location.href = finalUrl;
            }
        }, 1000);
    },

    // رندر الفيديوهات
    renderVideoGrid(list) {
        const grid = document.getElementById('ui-video-grid');
        if (list.length === 0) {
            grid.innerHTML = '<p style="padding:20px; opacity:0.5;">لا توجد فيديوهات مضافة حالياً.</p>';
            return;
        }

        grid.innerHTML = list.map((v, index) => `
            <div class="thumb-card" onclick="App.playVideo(${index})">
                <div class="thumb-image-box">
                    <img src="${this.getThumbnail(v.url)}" alt="thumbnail">
                </div>
                <div class="thumb-info">
                    <div class="thumb-title">${v.title}</div>
                </div>
            </div>
        `).join('');
    },

    // تشغيل فيديو معين
    playVideo(index) {
        const v = this.db.videos[index];
        if (!v) return;

        const player = document.getElementById('main-player-frame');
        const title = document.getElementById('ui-active-video-title');
        const desc = document.getElementById('ui-video-description');

        title.innerText = v.title;
        desc.innerHTML = this.linkify(v.desc);
        
        player.innerHTML = `<iframe src="${this.formatEmbedUrl(v.url)}?autoplay=1" allowfullscreen></iframe>`;
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    },

    // تحويل الروابط العادية إلى Embed
    formatEmbedUrl(url) {
        if (url.includes('youtube.com/watch?v=')) {
            return url.replace('watch?v=', 'embed/');
        }
        if (url.includes('youtu.be/')) {
            return url.replace('youtu.be/', 'youtube.com/embed/');
        }
        return url;
    },

    // جلب صورة مصغرة تلقائياً
    getThumbnail(url) {
        if (url.includes('youtube.com') || url.includes('youtu.be')) {
            const id = url.split('v=')[1]?.split('&')[0] || url.split('/').pop();
            return `https://img.youtube.com/vi/${id}/mqdefault.jpg`;
        }
        return 'https://via.placeholder.com/640x360/111/fff?text=Video+Preview';
    },

    // تحويل النصوص إلى روابط قابلة للضغط
    linkify(text) {
        const urlPattern = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
        return text.replace(urlPattern, '<a href="$1" target="_blank">$1</a>');
    },

    // --- نظام الإدارة (Admin Functions) ---

    showAuthModal() {
        this.toggleMenu();
        const wrapper = document.getElementById('auth-inputs-wrapper');
        wrapper.innerHTML = '';
        
        // توليد خانات الدخول حسب عدد الأكواد
        this.db.config.authCodes.forEach((_, i) => {
            wrapper.innerHTML += `<input type="password" class="admin-input auth-field" placeholder="الرمز السري ${i+1}">`;
        });

        document.getElementById('auth-modal').style.display = 'flex';
    },

    verifyAuth() {
        const fields = document.querySelectorAll('.auth-field');
        let access = true;
        
        fields.forEach((f, i) => {
            if (f.value !== this.db.config.authCodes[i]) access = false;
        });

        if (access) {
            this.closeAllModals();
            document.getElementById('admin-main-modal').style.display = 'flex';
        } else {
            alert("خطأ في أكواد الدخول! يرجى المحاولة مرة أخرى.");
        }
    },

    openSubAdmin(type) {
        this.closeAllModals();
        const modalId = 'sub-admin-' + type;
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'flex';
            this.syncAdminFields(type);
        }
    },

    syncAdminFields(type) {
        // تعبئة البيانات في الخانات عند فتح لوحة التحكم الفرعية
        if (type === 'news') {
            document.getElementById('news-toggle').value = this.db.news.enabled;
            document.getElementById('news-text-val').value = this.db.news.text;
            document.getElementById('news-link-val').value = this.db.news.link;
            document.getElementById('news-bg-val').value = this.db.news.bgColor;
            document.getElementById('news-timer-val').value = this.db.news.timer;
        }
        if (type === 'header-settings') {
            document.getElementById('header-text-val').value = this.db.config.siteName;
            document.getElementById('header-size-val').value = this.db.config.headerFontSize;
            document.getElementById('header-color-val').value = this.db.config.headerColor;
            document.getElementById('header-mode-val').value = this.db.config.headerMode;
            document.getElementById('header-vid-url').value = this.db.config.headerVidUrl;
        }
        if (type === 'videos') {
            this.renderAdminVideoList();
        }
    },

    addVideoItem() {
        const url = document.getElementById('v-input-url').value;
        const title = document.getElementById('v-input-title').value;
        const desc = document.getElementById('v-input-desc').value;

        if (!url || !title) return alert("يرجى ملء الرابط والعنوان");

        this.db.videos.push({ url, title, desc });
        this.renderAdminVideoList();
        
        // تفريغ الخانات
        document.getElementById('v-input-url').value = '';
        document.getElementById('v-input-title').value = '';
        document.getElementById('v-input-desc').value = '';
    },

    renderAdminVideoList() {
        const container = document.getElementById('admin-video-list-items');
        container.innerHTML = this.db.videos.map((v, i) => `
            <div class="admin-form-group" style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <strong>${v.title}</strong><br>
                    <small style="opacity:0.5;">${v.url}</small>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="admin-btn" style="width:auto; padding:5px 15px; background:orange;" onclick="App.editVideo(${i})">تعديل</button>
                    <button class="admin-btn" style="width:auto; padding:5px 15px; background:red;" onclick="App.deleteVideo(${i})">حذف</button>
                </div>
            </div>
        `).join('');
    },

    deleteVideo(i) {
        if (confirm("هل تريد حذف هذا الفيديو؟")) {
            this.db.videos.splice(i, 1);
            this.renderAdminVideoList();
        }
    },

    editVideo(i) {
        const v = this.db.videos[i];
        document.getElementById('v-input-url').value = v.url;
        document.getElementById('v-input-title').value = v.title;
        document.getElementById('v-input-desc').value = v.desc;
        this.db.videos.splice(i, 1); // سحب للتعديل ثم إعادة الإضافة عند الحفظ
    },

    updateNewsConfig() {
        this.db.news.enabled = document.getElementById('news-toggle').value === 'true';
        this.db.news.text = document.getElementById('news-text-val').value;
        this.db.news.link = document.getElementById('news-link-val').value;
        this.db.news.bgColor = document.getElementById('news-bg-val').value;
        this.db.news.timer = parseInt(document.getElementById('news-timer-val').value);
        this.db.news.startTime = Date.now();
        alert("تم تحديث الخبر العاجل!");
    },

    updateHeaderConfig() {
        this.db.config.siteName = document.getElementById('header-text-val').value;
        this.db.config.headerFontSize = document.getElementById('header-size-val').value;
        this.db.config.headerColor = document.getElementById('header-color-val').value;
        this.db.config.headerMode = document.getElementById('header-mode-val').value;
        this.db.config.headerVidUrl = document.getElementById('header-vid-url').value;
        alert("تم تحديث الهيدر!");
    },

    // حفظ عام
    saveAllAndReload() {
        localStorage.setItem('MAHER_CMS_DATA', JSON.stringify(this.db));
        location.reload();
    },

    // --- أدوات عامة ---
    toggleMenu() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        sidebar.classList.toggle('active');
        overlay.style.display = sidebar.classList.contains('active') ? 'block' : 'none';
    },

    closeAllModals() {
        document.querySelectorAll('.full-screen-modal, .redirect-fullscreen').forEach(m => m.style.display = 'none');
    },

    backToMainAdmin() {
        this.closeAllModals();
        document.getElementById('admin-main-modal').style.display = 'flex';
    },

    toggleDescription() {
        const desc = document.getElementById('ui-video-description');
        desc.style.display = desc.style.display === 'block' ? 'none' : 'block';
    },

    toggleTheme() {
        this.db.config.theme = this.db.config.theme === 'dark' ? 'light' : 'dark';
        this.applyConfigurations();
    },

    setupEventListeners() {
        // غلق القائمة عند الضغط في أي مكان خارجها
        document.addEventListener('click', (e) => {
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('active') && !sidebar.contains(e.target) && e.target.className !== 'fas fa-bars tool-icon') {
                // this.toggleMenu(); // مفعلة عبر overlay
            }
        });
    }
};

// تشغيل المحرك عند التحميل
window.onload = () => App.init();
</script>
</body>
</html>
